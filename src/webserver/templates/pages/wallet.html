<div class="wallet-page">
  <style>
    .wallet-page {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
      padding: 12px 16px 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .wallet-tabs {
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .wallet-tab {
      border: 1px solid var(--border-color);
      background: color-mix(in srgb, var(--bg-card) 92%, transparent);
      color: var(--text-secondary);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .wallet-tab.active {
      background: var(--link-color);
      border-color: var(--link-color);
      color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    .wallet-tab:hover:not(.active) {
      border-color: var(--link-color);
      color: var(--link-color);
    }

    .wallet-tab-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1 1 auto;
    }

    .tab-pane {
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    .tab-pane.active {
      display: flex;
    }

    .wallet-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .wallet-summary-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .wallet-summary-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    .wallet-summary-value {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
      line-height: 1.2;
    }

    .wallet-summary-subvalue {
      font-size: 0.78rem;
      color: var(--text-secondary);
      display: flex;
      gap: 6px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .wallet-analysis-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 14px 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .wallet-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .wallet-chart-title {
      font-weight: 600;
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .wallet-header-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .wallet-meta-text {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .wallet-range-buttons {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .wallet-range-buttons button {
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .wallet-range-buttons button.active {
      background: var(--link-color);
      border-color: var(--link-color);
      color: #fff;
    }

    .wallet-range-buttons button:hover:not(.active) {
      border-color: var(--link-color);
      color: var(--link-color);
    }

    #wallet-flow-chart {
      width: 100%;
      min-height: 320px;
    }

    .wallet-flow-metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .wallet-metric-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .wallet-metric-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    .wallet-metric-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .wallet-token-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .wallet-token-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .wallet-token-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .wallet-search-wrapper {
      display: flex;
      align-items: center;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-primary);
      overflow: hidden;
      min-width: 220px;
    }

    .wallet-search-wrapper input {
      border: none;
      outline: none;
      background: transparent;
      padding: 6px 10px;
      flex: 1;
      color: var(--text-primary);
      font-size: 0.82rem;
    }

    .wallet-search-wrapper button {
      border: none;
      background: transparent;
      color: var(--text-muted);
      padding: 0 10px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .wallet-sort-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    .wallet-sort-select {
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 0.78rem;
      min-width: 140px;
    }

    .wallet-token-table-wrapper {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .wallet-token-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .wallet-token-table thead th {
      background: color-mix(in srgb, var(--bg-primary) 92%, transparent);
      padding: 10px 12px;
      text-align: left;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .wallet-token-table tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.82rem;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .wallet-token-table tbody tr:last-child td {
      border-bottom: none;
    }

    .wallet-table-body-scroll {
      overflow: auto;
      max-height: 68vh;
    }

    .token-info-cell {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .token-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .token-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .token-symbol {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .token-name {
      font-size: 0.72rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .token-mint {
      font-size: 0.68rem;
      font-family: "SF Mono", "Menlo", monospace;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .wallet-empty-state {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 28px;
      border: 1px dashed var(--border-color);
      border-radius: 12px;
      background: color-mix(in srgb, var(--bg-card) 92%, transparent);
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .wallet-empty-state[data-visible="true"] {
      display: flex;
    }

    .wallet-error-banner {
      display: none;
      padding: 12px 16px;
      border-radius: 10px;
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #ef4444;
      font-size: 0.85rem;
    }

    .wallet-error-banner[data-visible="true"] {
      display: block;
    }

    @media (max-width: 960px) {
      #wallet-flow-chart {
        min-height: 260px;
      }
      .wallet-summary-grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
    }
  </style>

  <div class="wallet-tabs" role="tablist" aria-label="Wallet sections">
    <button
      type="button"
      class="wallet-tab active"
      data-tab="analysis"
      id="analysis-tab-button"
      aria-controls="analysis-tab"
      aria-selected="true"
    >
      ðŸ“Š Analysis
    </button>
    <button
      type="button"
      class="wallet-tab"
      data-tab="tokens"
      id="tokens-tab-button"
      aria-controls="tokens-tab"
      aria-selected="false"
    >
      ðŸª™ Tokens
    </button>
  </div>

  <div id="wallet-error" class="wallet-error-banner" data-visible="false"></div>

  <div class="wallet-tab-content">
    <div
      id="analysis-tab"
      class="tab-pane active"
      role="tabpanel"
      aria-labelledby="analysis-tab-button"
    >
      <div class="wallet-summary-grid">
        <div class="wallet-summary-card">
          <span class="wallet-summary-label">Sol Balance</span>
          <span id="wallet-summary-sol" class="wallet-summary-value">â€”</span>
          <div class="wallet-summary-subvalue">
            <span id="wallet-summary-change">â€”</span>
            <span id="wallet-summary-percent" class="value-positive">â€”</span>
          </div>
        </div>
        <div class="wallet-summary-card">
          <span class="wallet-summary-label">Tokens Held</span>
          <span id="wallet-summary-tokens" class="wallet-summary-value">â€”</span>
          <div class="wallet-summary-subvalue">
            <span id="wallet-summary-last-updated">Last snapshot â€”</span>
          </div>
        </div>
        <div class="wallet-summary-card">
          <span class="wallet-summary-label">Flow Window</span>
          <span id="wallet-summary-window" class="wallet-summary-value">â€”</span>
          <div class="wallet-summary-subvalue">
            <span id="wallet-summary-net">Net â€”</span>
            <span id="wallet-summary-tx-count">0 tx</span>
          </div>
        </div>
      </div>

      <div class="wallet-analysis-card">
        <div class="wallet-card-header">
          <span class="wallet-chart-title">ðŸ“ˆ Flow Analysis</span>
          <div class="wallet-header-meta">
            <span id="wallet-chart-meta" class="wallet-meta-text">â€”</span>
            <div class="wallet-range-buttons" id="wallet-range-buttons">
              <button type="button" data-range-hours="1">1h</button>
              <button type="button" data-range-hours="6">6h</button>
              <button type="button" data-range-hours="12">12h</button>
              <button type="button" data-range-hours="24">24h</button>
              <button type="button" data-range-hours="72">72h</button>
              <button type="button" data-range-hours="168">7d</button>
              <button type="button" data-range-hours="336">14d</button>
              <button type="button" data-range-hours="720">30d</button>
              <button type="button" data-range-hours="2160">90d</button>
              <button type="button" data-range-hours="4320">180d</button>
              <button type="button" data-range-hours="8760">1y</button>
              <button type="button" data-range-hours="0" class="active">
                All
              </button>
            </div>
          </div>
        </div>
        <div id="wallet-flow-chart"></div>
      </div>

      <div class="wallet-flow-metrics-grid">
        <div class="wallet-metric-card">
          <span class="wallet-metric-label">Inflow</span>
          <span id="wallet-flow-in" class="wallet-metric-value value-positive"
            >â€”</span
          >
        </div>
        <div class="wallet-metric-card">
          <span class="wallet-metric-label">Outflow</span>
          <span id="wallet-flow-out" class="wallet-metric-value value-negative"
            >â€”</span
          >
        </div>
        <div class="wallet-metric-card">
          <span class="wallet-metric-label">Net</span>
          <span id="wallet-flow-net" class="wallet-metric-value">â€”</span>
        </div>
        <div class="wallet-metric-card">
          <span class="wallet-metric-label">Transactions</span>
          <span id="wallet-flow-count" class="wallet-metric-value">0</span>
        </div>
      </div>
      <span id="wallet-flow-window" class="wallet-meta-text">Window â€”</span>
    </div>

    <div
      id="tokens-tab"
      class="tab-pane"
      role="tabpanel"
      aria-labelledby="tokens-tab-button"
    >
      <div class="wallet-token-panel">
        <div class="wallet-token-panel-header">
          <span class="toolbar-title">Wallet Tokens</span>
          <span id="wallet-token-count" class="wallet-meta-text">â€”</span>
        </div>
        <div class="wallet-token-controls">
          <div class="wallet-search-wrapper">
            <input
              type="text"
              id="wallet-token-search"
              placeholder="Search by symbol, name, or mint"
              autocomplete="off"
            />
            <button id="wallet-token-clear" type="button" title="Clear">
              âœ•
            </button>
          </div>
          <label class="wallet-sort-label" for="wallet-sort-select">
            Sort:
            <select id="wallet-sort-select" class="wallet-sort-select">
              <option value="value_desc">Value â–¼</option>
              <option value="value_asc">Value â–²</option>
              <option value="balance_desc">Balance â–¼</option>
              <option value="balance_asc">Balance â–²</option>
              <option value="liquidity_desc">Liquidity â–¼</option>
              <option value="liquidity_asc">Liquidity â–²</option>
            </select>
          </label>
        </div>
      </div>

      <div class="wallet-token-table-wrapper">
        <table class="wallet-token-table">
          <thead>
            <tr>
              <th style="width: 36%">Token</th>
              <th style="width: 14%">Balance</th>
              <th style="width: 14%">Value (SOL)</th>
              <th style="width: 14%">Price (SOL)</th>
              <th style="width: 11%">Liquidity (USD)</th>
              <th style="width: 11%">24h Volume</th>
            </tr>
          </thead>
        </table>
        <div class="wallet-table-body-scroll">
          <table class="wallet-token-table">
            <tbody id="wallet-token-table-body"></tbody>
          </table>
        </div>
      </div>

      <div
        id="wallet-empty-state"
        class="wallet-empty-state"
        data-visible="false"
      >
        <span style="font-size: 2rem">ðŸª™</span>
        <span>No tokens detected in wallet.</span>
        <span
          >Snapshots update every minute while the monitoring service
          runs.</span
        >
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const SOL_FORMAT = new Intl.NumberFormat("en-US", {
      minimumFractionDigits: 4,
      maximumFractionDigits: 6,
    });
    const NUMBER_FORMAT = new Intl.NumberFormat("en-US", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
    const COMPACT_FORMAT = new Intl.NumberFormat("en-US", {
      notation: "compact",
      maximumFractionDigits: 1,
    });

    const FALLBACK_LOGO =
      "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' fill='none'%3E%3Crect width='64' height='64' rx='32' fill='%2333415E'/%3E%3Cpath fill='%23ffffff' d='M32 18c7.732 0 14 6.268 14 14s-6.268 14-14 14-14-6.268-14-14 6.268-14 14-14Zm0 6c-4.418 0-8 3.582-8 8 0 4.417 3.582 8 8 8 4.417 0 8-3.583 8-8 0-4.418-3.583-8-8-8Z'/%3E%3C/svg%3E";

    const SORTERS = {
      value_desc: (a, b) => (b.value_sol ?? 0) - (a.value_sol ?? 0),
      value_asc: (a, b) => (a.value_sol ?? 0) - (b.value_sol ?? 0),
      balance_desc: (a, b) => (b.balance_ui ?? 0) - (a.balance_ui ?? 0),
      balance_asc: (a, b) => (a.balance_ui ?? 0) - (b.balance_ui ?? 0),
      liquidity_desc: (a, b) => (b.liquidity_usd ?? 0) - (a.liquidity_usd ?? 0),
      liquidity_asc: (a, b) => (a.liquidity_usd ?? 0) - (b.liquidity_usd ?? 0),
    };

    const State = {
      windowHours: 0,
      search: "",
      sort: "value_desc",
      tokens: [],
      dailyFlows: [],
      poller: null,
      chart: null,
      chartSeries: null,
      themeObserver: null,
      activeTab: "analysis",
    };

    const el = (id) => document.getElementById(id);

    function formatSol(value) {
      if (value == null || Number.isNaN(value)) return "â€”";
      const abs = Math.abs(value);
      if (abs >= 1000) {
        return `${COMPACT_FORMAT.format(value)} SOL`;
      }
      return `${SOL_FORMAT.format(value)} SOL`;
    }

    function formatNumber(value, fallback = "â€”") {
      if (value == null || Number.isNaN(value)) return fallback;
      if (Math.abs(value) >= 1000000) {
        return COMPACT_FORMAT.format(value);
      }
      return NUMBER_FORMAT.format(value);
    }

    function setText(id, value) {
      const node = el(id);
      if (node) {
        node.textContent = value;
      }
    }

    function formatMintLabel(mint) {
      if (!mint) return "â€”";
      if (mint.length <= 10) return mint;
      return `${mint.slice(0, 4)}â€¦${mint.slice(-4)}`;
    }

    function logoSources(mint) {
      if (!mint) {
        return [FALLBACK_LOGO];
      }
      const encodedMint = encodeURIComponent(mint);
      return [
        `https://cdn.helius-rpc.com/cdn-cgi/image/width=64,fit=scale-down,format=auto/https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/${encodedMint}/logo.png`,
        `https://tokens.jup.ag/${encodedMint}/logo.png`,
        FALLBACK_LOGO,
      ];
    }

    function clearChart() {
      if (State.chart) {
        State.chart.remove();
        State.chart = null;
        State.chartSeries = null;
      }
    }

    function applyChartTheme() {
      if (!State.chart) return;
      const theme =
        document.documentElement.getAttribute("data-theme") || "light";
      const isDark = theme === "dark";
      State.chart.applyOptions({
        layout: {
          background: { color: "transparent" },
          textColor: isDark ? "#d1d4dc" : "#1f2933",
        },
        grid: {
          vertLines: {
            color: isDark ? "rgba(255,255,255,0.05)" : "rgba(0,0,0,0.05)",
          },
          horzLines: {
            color: isDark ? "rgba(255,255,255,0.05)" : "rgba(0,0,0,0.05)",
          },
        },
      });

      if (!State.chartSeries) return;

      const { inflow, outflow, net } = State.chartSeries;
      if (inflow) {
        inflow.applyOptions({
          color: isDark ? "#22c55e" : "#16a34a",
        });
      }
      if (outflow) {
        outflow.applyOptions({
          color: isDark ? "#f87171" : "#ef4444",
        });
      }
      if (net) {
        net.applyOptions({
          lineColor: isDark ? "#60a5fa" : "#2563eb",
          topColor: isDark
            ? "rgba(96, 165, 250, 0.32)"
            : "rgba(37, 99, 235, 0.24)",
          bottomColor: isDark
            ? "rgba(96, 165, 250, 0.04)"
            : "rgba(37, 99, 235, 0.06)",
        });
      }
    }

    function ensureChart() {
      if (State.chart) return;
      const container = el("wallet-flow-chart");
      if (!container) return;

      State.chart = LightweightCharts.createChart(container, {
        height: 320,
        layout: { background: { color: "transparent" }, textColor: "#1f2933" },
        timeScale: {
          borderVisible: false,
          timeVisible: true,
          secondsVisible: false,
        },
        rightPriceScale: { borderVisible: false },
        localization: { dateFormat: "yyyy-MM-dd" },
        grid: {
          vertLines: { color: "rgba(0,0,0,0.05)" },
          horzLines: { color: "rgba(0,0,0,0.05)" },
        },
      });

      const inflow = State.chart.addLineSeries({ lineWidth: 2 });
      const outflow = State.chart.addLineSeries({ lineWidth: 2 });
      const net = State.chart.addAreaSeries({
        lineWidth: 2,
        priceFormat: { type: "price", precision: 6, minMove: 0.000001 },
      });

      State.chartSeries = { inflow, outflow, net };
      applyChartTheme();
    }

    function updateChart(dailyFlows) {
      ensureChart();
      if (!State.chartSeries) return;
      const flows = Array.isArray(dailyFlows) ? dailyFlows : [];

      const cutoff =
        State.windowHours > 0
          ? Math.floor(Date.now() / 1000) - State.windowHours * 3600
          : null;

      const filtered = cutoff
        ? flows.filter((point) => Number(point.timestamp) >= cutoff)
        : flows;

      const inflowData = filtered.map((d) => ({
        time: Number(d.timestamp),
        value: Number(d.inflow ?? 0),
      }));
      const outflowData = filtered.map((d) => ({
        time: Number(d.timestamp),
        value: Number(d.outflow ?? 0),
      }));
      const netData = filtered.map((d) => ({
        time: Number(d.timestamp),
        value: Number(d.net ?? 0),
      }));

      State.chartSeries.inflow.setData(inflowData);
      State.chartSeries.outflow.setData(outflowData);
      State.chartSeries.net.setData(netData);

      if (State.chart && netData.length > 0) {
        State.chart.timeScale().fitContent();
      }
    }

    function filterTokens() {
      const query = State.search.trim().toLowerCase();
      const tokens = Array.isArray(State.tokens) ? [...State.tokens] : [];
      const sorter = SORTERS[State.sort] || SORTERS.value_desc;
      tokens.sort(sorter);

      if (!query) {
        return tokens;
      }

      return tokens.filter((token) => {
        const symbol = (token.symbol || "").toLowerCase();
        const name = (token.name || "").toLowerCase();
        const mint = (token.mint || "").toLowerCase();
        return (
          symbol.includes(query) || name.includes(query) || mint.includes(query)
        );
      });
    }

    function renderTokens() {
      const tbody = el("wallet-token-table-body");
      const emptyState = el("wallet-empty-state");
      if (!tbody) return;

      tbody.innerHTML = "";
      const tokens = filterTokens();

      const fragment = document.createDocumentFragment();

      tokens.forEach((token) => {
        const row = document.createElement("tr");

        const infoCell = document.createElement("td");
        infoCell.className = "token-info-cell";

        const logo = document.createElement("img");
        logo.className = "token-logo";
        logo.alt = `${token.symbol || token.name || "Token"} logo`;
        logo.loading = "lazy";

        const sources = logoSources(token.mint);
        let sourceIndex = 0;
        const swapSource = () => {
          sourceIndex += 1;
          if (sourceIndex < sources.length) {
            logo.src = sources[sourceIndex];
          } else {
            logo.onerror = null;
            logo.src = FALLBACK_LOGO;
          }
        };

        logo.onerror = swapSource;
        logo.src = sources[sourceIndex];

        const text = document.createElement("div");
        text.className = "token-text";

        const symbol = document.createElement("div");
        symbol.className = "token-symbol";
        symbol.textContent = token.symbol || formatMintLabel(token.mint);

        const name = document.createElement("div");
        name.className = "token-name";
        name.textContent = token.name || "â€”";

        const mint = document.createElement("div");
        mint.className = "token-mint";
        mint.textContent = formatMintLabel(token.mint);
        mint.title = token.mint || "";

        text.appendChild(symbol);
        text.appendChild(name);
        text.appendChild(mint);

        infoCell.appendChild(logo);
        infoCell.appendChild(text);

        const balanceCell = document.createElement("td");
        balanceCell.textContent = formatNumber(token.balance_ui || 0, "0.00");

        const valueCell = document.createElement("td");
        valueCell.textContent = formatSol(token.value_sol);

        const priceCell = document.createElement("td");
        priceCell.textContent = formatSol(token.price_sol);

        const liquidityCell = document.createElement("td");
        liquidityCell.textContent =
          token.liquidity_usd != null
            ? `$${formatNumber(token.liquidity_usd)}`
            : "â€”";

        const volumeCell = document.createElement("td");
        volumeCell.textContent =
          token.volume_24h != null ? `$${formatNumber(token.volume_24h)}` : "â€”";

        row.appendChild(infoCell);
        row.appendChild(balanceCell);
        row.appendChild(valueCell);
        row.appendChild(priceCell);
        row.appendChild(liquidityCell);
        row.appendChild(volumeCell);

        fragment.appendChild(row);
      });

      tbody.appendChild(fragment);

      if (emptyState) {
        emptyState.setAttribute(
          "data-visible",
          tokens.length === 0 ? "true" : "false"
        );
      }

      setText("wallet-token-count", `Total: ${tokens.length} tokens`);
    }

    function updateSummary(payload) {
      if (!payload) return;
      const { summary, flows } = payload;

      if (summary) {
        setText("wallet-summary-sol", formatSol(summary.current_sol_balance));
        setText("wallet-summary-change", formatSol(summary.sol_change));

        const pct = summary.sol_change_percent;
        const percentNode = el("wallet-summary-percent");
        if (percentNode) {
          if (pct != null) {
            percentNode.textContent = `${pct >= 0 ? "+" : ""}${pct.toFixed(
              2
            )}%`;
            percentNode.classList.toggle("value-positive", pct >= 0);
            percentNode.classList.toggle("value-negative", pct < 0);
          } else {
            percentNode.textContent = "â€”";
            percentNode.classList.remove("value-positive", "value-negative");
          }
        }

        setText("wallet-summary-tokens", `${summary.token_count}`);
        setText(
          "wallet-summary-last-updated",
          summary.last_snapshot_time
            ? `Last snapshot ${new Date(
                summary.last_snapshot_time
              ).toLocaleTimeString()}`
            : "Last snapshot â€”"
        );
      }

      if (flows) {
        const windowLabel =
          flows.window_hours === 0
            ? "All-time window"
            : `${flows.window_hours}h window`;
        setText("wallet-summary-window", windowLabel);
        setText("wallet-summary-net", formatSol(flows.net_sol));
        setText("wallet-summary-tx-count", `${flows.transactions_analyzed} tx`);
        setText("wallet-flow-in", formatSol(flows.inflow_sol));
        setText("wallet-flow-out", formatSol(flows.outflow_sol));
        setText("wallet-flow-count", `${flows.transactions_analyzed}`);
        setText("wallet-flow-window", windowLabel);

        const netNode = el("wallet-flow-net");
        if (netNode) {
          netNode.textContent = formatSol(flows.net_sol);
          netNode.classList.toggle("value-positive", flows.net_sol >= 0);
          netNode.classList.toggle("value-negative", flows.net_sol < 0);
        }
      }

      if (payload.last_updated) {
        setText(
          "wallet-chart-meta",
          `Updated ${new Date(payload.last_updated).toLocaleTimeString()}`
        );
      }
    }

    function computeSnapshotLimit() {
      if (State.windowHours <= 0) {
        return 600;
      }
      const estimate = State.windowHours * 60 + 120;
      return Math.min(Math.max(estimate, 120), 2880);
    }

    async function fetchDashboard() {
      const requestPayload = {
        windowHours: State.windowHours,
        snapshotLimit: computeSnapshotLimit(),
        maxTokens: 500,
      };
      const response = await fetch(`/api/wallet/dashboard`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify(requestPayload),
      });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      return response.json();
    }

    function handlePayload(payload) {
      const banner = el("wallet-error");
      if (banner) {
        banner.setAttribute("data-visible", "false");
        banner.textContent = "";
      }

      if (!payload) return;
      if (payload.error) {
        if (banner) {
          banner.textContent = payload.error;
          banner.setAttribute("data-visible", "true");
        }
        return;
      }

      const data = payload.data;
      if (!data) return;

      State.tokens = data.tokens || [];
      State.dailyFlows = data.daily_flows || [];

      updateSummary(data);
      updateChart(State.dailyFlows);
      renderTokens();
    }

    function startPolling() {
      if (State.poller) {
        State.poller.restart();
        return;
      }
      State.poller = PagePoller.create({
        label: "WalletDashboard",
        onPoll: async () => {
          try {
            const payload = await fetchDashboard();
            handlePayload(payload);
          } catch (err) {
            console.error("Failed to poll wallet dashboard", err);
            const banner = el("wallet-error");
            if (banner) {
              banner.textContent = "Unable to refresh wallet data.";
              banner.setAttribute("data-visible", "true");
            }
          }
        },
      });
      State.poller.start();
    }

    function bindRangeButtons() {
      const buttonsWrap = el("wallet-range-buttons");
      if (!buttonsWrap || buttonsWrap.__walletBound) return;

      buttonsWrap.__walletBound = true;
      buttonsWrap.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-range-hours]");
        if (!button) return;

        const hours = Number(button.dataset.rangeHours);
        if (!Number.isFinite(hours)) return;

        State.windowHours = hours;
        buttonsWrap.querySelectorAll("button").forEach((btn) => {
          const isActive = btn === button;
          btn.classList.toggle("active", isActive);
          if (isActive) {
            btn.setAttribute("aria-pressed", "true");
          } else {
            btn.setAttribute("aria-pressed", "false");
          }
        });
        startPolling();
      });
    }

    function bindSearch() {
      const searchInput = el("wallet-token-search");
      if (searchInput && !searchInput.__walletBound) {
        searchInput.__walletBound = true;
        searchInput.addEventListener("input", (event) => {
          State.search = event.target.value;
          renderTokens();
        });
      }

      const clearBtn = el("wallet-token-clear");
      if (clearBtn && !clearBtn.__walletBound) {
        clearBtn.__walletBound = true;
        clearBtn.addEventListener("click", () => {
          State.search = "";
          if (searchInput) {
            searchInput.value = "";
          }
          renderTokens();
        });
      }
    }

    function bindSort() {
      const sortSelect = el("wallet-sort-select");
      if (sortSelect && !sortSelect.__walletBound) {
        sortSelect.__walletBound = true;
        sortSelect.value = State.sort;
        sortSelect.addEventListener("change", (event) => {
          const value = event.target.value;
          if (SORTERS[value]) {
            State.sort = value;
            renderTokens();
            AppState.save("wallet.sort", State.sort);
          }
        });
      }
    }

    function restorePreferences() {
      const savedSort = AppState.load("wallet.sort");
      if (savedSort && SORTERS[savedSort]) {
        State.sort = savedSort;
      }

      const sortSelect = el("wallet-sort-select");
      if (sortSelect) {
        sortSelect.value = State.sort;
      }

      const savedTab = AppState.load("wallet.activeTab");
      if (savedTab === "tokens" || savedTab === "analysis") {
        switchTab(savedTab, { suppressSave: true });
      }
    }

    function switchTab(tabName, options = {}) {
      if (tabName !== "analysis" && tabName !== "tokens") {
        tabName = "analysis";
      }

      State.activeTab = tabName;

      const analysisTab = document.querySelector("#analysis-tab");
      const tokensTab = document.querySelector("#tokens-tab");
      const analysisButton = document.querySelector("#analysis-tab-button");
      const tokensButton = document.querySelector("#tokens-tab-button");

      if (analysisTab) {
        analysisTab.classList.toggle("active", tabName === "analysis");
      }
      if (tokensTab) {
        tokensTab.classList.toggle("active", tabName === "tokens");
      }

      if (analysisButton) {
        const isActive = tabName === "analysis";
        analysisButton.classList.toggle("active", isActive);
        analysisButton.setAttribute("aria-selected", String(isActive));
      }
      if (tokensButton) {
        const isActive = tabName === "tokens";
        tokensButton.classList.toggle("active", isActive);
        tokensButton.setAttribute("aria-selected", String(isActive));
      }

      if (!options.suppressSave) {
        AppState.save("wallet.activeTab", tabName);
      }
    }

    function bindTabs() {
      const tabs = document.querySelectorAll(".wallet-tab");
      tabs.forEach((tab) => {
        if (tab.__walletBound) return;
        tab.__walletBound = true;
        tab.addEventListener("click", () => {
          const targetTab = tab.dataset.tab || "analysis";
          switchTab(targetTab);
        });
      });
    }

    function registerCleanup() {
      Router.registerCleanup(() => {
        if (State.poller) {
          State.poller.cleanup();
          State.poller = null;
        }
        if (State.themeObserver) {
          State.themeObserver.disconnect();
          State.themeObserver = null;
        }
        clearChart();
      });
    }

    function observeTheme() {
      if (State.themeObserver) return;
      State.themeObserver = new MutationObserver(applyChartTheme);
      State.themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["data-theme"],
      });
    }

    window.initWalletPage = function () {
      console.log("[Wallet] Initializing page");
      registerCleanup();
      observeTheme();
      bindTabs();
      bindRangeButtons();
      bindSearch();
      bindSort();
      restorePreferences();
      renderTokens();
      startPolling();
    };

    if (document.readyState !== "loading") {
      window.initWalletPage();
    } else {
      document.addEventListener("DOMContentLoaded", window.initWalletPage, {
        once: true,
      });
    }
  })();
</script>
