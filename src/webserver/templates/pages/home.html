<div class="home-page">
  <style>
    .home-page {
      padding: 20px 24px;
      max-width: 1800px;
      margin: 0 auto;
    }

    /* Hero Section */
    .hero-section {
      background: linear-gradient(
        135deg,
        color-mix(in srgb, var(--link-color) 15%, var(--bg-card)),
        color-mix(in srgb, var(--link-color) 5%, var(--bg-card))
      );
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .hero-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .hero-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .hero-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }

    .hero-status-badge.active {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .hero-status-badge.inactive {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .hero-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .hero-metric {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hero-metric-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .hero-metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
      line-height: 1.2;
    }

    .hero-metric-change {
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .hero-metric-change.positive {
      color: #22c55e;
    }

    .hero-metric-change.negative {
      color: #ef4444;
    }

    /* Quick Stats Grid */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-color: var(--link-color);
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-card-icon {
      font-size: 1.5rem;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: color-mix(in srgb, var(--link-color) 15%, transparent);
    }

    .stat-card-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-card-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-variant-numeric: tabular-nums;
    }

    .stat-card-subtitle {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Main Content Grid */
    .main-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .main-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      display: flex;
      flex-direction: column;
    }

    .main-card.col-span-8 {
      grid-column: span 8;
    }

    .main-card.col-span-4 {
      grid-column: span 4;
    }

    .main-card.col-span-6 {
      grid-column: span 6;
    }

    .main-card.col-span-12 {
      grid-column: span 12;
    }

    @media (max-width: 1200px) {
      .main-card.col-span-8,
      .main-card.col-span-4,
      .main-card.col-span-6 {
        grid-column: span 12;
      }
    }

    .main-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .main-card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .main-card-action {
      font-size: 0.8rem;
      color: var(--link-color);
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .main-card-action:hover {
      background: color-mix(in srgb, var(--link-color) 10%, transparent);
    }

    /* Recent Positions Table */
    .positions-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .positions-table thead th {
      text-align: left;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
    }

    .positions-table tbody td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.85rem;
      color: var(--text-primary);
    }

    .positions-table tbody tr:last-child td {
      border-bottom: none;
    }

    .positions-table tbody tr:hover {
      background: color-mix(in srgb, var(--link-color) 5%, transparent);
    }

    .token-symbol {
      font-weight: 600;
      color: var(--text-primary);
    }

    .position-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .position-status.open {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .position-status.closed {
      background: rgba(148, 163, 184, 0.15);
      color: #94a3b8;
    }

    /* System Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .metric-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .metric-item-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .metric-item-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    /* Activity Feed */
    .activity-feed {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }

    .activity-item:hover {
      border-color: var(--link-color);
      transform: translateX(4px);
    }

    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .activity-icon.success {
      background: rgba(34, 197, 94, 0.15);
    }

    .activity-icon.error {
      background: rgba(239, 68, 68, 0.15);
    }

    .activity-icon.info {
      background: rgba(59, 130, 246, 0.15);
    }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .activity-description {
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .activity-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 0.9rem;
    }

    /* Loading Skeleton */
    .skeleton {
      background: linear-gradient(
        90deg,
        var(--bg-card) 25%,
        color-mix(in srgb, var(--bg-card) 90%, white) 50%,
        var(--bg-card) 75%
      );
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
      border-radius: 4px;
      height: 20px;
    }

    @keyframes skeleton-loading {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }
  </style>

  <!-- Hero Section -->
  <div class="hero-section">
    <div class="hero-header">
      <div class="hero-title">
        <span>ü§ñ</span>
        <span>ScreenerBot Dashboard</span>
      </div>
      <div class="hero-status-badge" id="heroStatusBadge">
        <span id="heroStatusDot">‚óè</span>
        <span id="heroStatusText">Loading...</span>
      </div>
    </div>

    <div class="hero-metrics">
      <div class="hero-metric">
        <div class="hero-metric-label">Total P&L</div>
        <div class="hero-metric-value" id="heroPnl">--</div>
        <div class="hero-metric-change" id="heroPnlChange">
          <span>--</span>
        </div>
      </div>

      <div class="hero-metric">
        <div class="hero-metric-label">Open Positions</div>
        <div class="hero-metric-value" id="heroOpenPositions">--</div>
        <div class="hero-metric-change" id="heroPositionsInfo">--</div>
      </div>

      <div class="hero-metric">
        <div class="hero-metric-label">SOL Balance</div>
        <div class="hero-metric-value" id="heroSolBalance">--</div>
        <div class="hero-metric-change" id="heroBalanceChange">--</div>
      </div>

      <div class="hero-metric">
        <div class="hero-metric-label">Win Rate</div>
        <div class="hero-metric-value" id="heroWinRate">--</div>
        <div class="hero-metric-change" id="heroWinRateInfo">--</div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="quick-stats">
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon">üìä</div>
        <div class="stat-card-title">Total Trades</div>
      </div>
      <div class="stat-card-value" id="statTotalTrades">--</div>
      <div class="stat-card-subtitle" id="statTradesInfo">
        All-time activity
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon">üí∞</div>
        <div class="stat-card-title">Invested</div>
      </div>
      <div class="stat-card-value" id="statInvested">--</div>
      <div class="stat-card-subtitle">Currently in positions</div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon">üõ∞Ô∏è</div>
        <div class="stat-card-title">Monitoring</div>
      </div>
      <div class="stat-card-value" id="statMonitoring">--</div>
      <div class="stat-card-subtitle" id="statMonitoringInfo">
        Tokens tracked
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon">‚ö°</div>
        <div class="stat-card-title">System Health</div>
      </div>
      <div class="stat-card-value" id="statHealth">--</div>
      <div class="stat-card-subtitle" id="statHealthInfo">Services status</div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="main-grid">
    <!-- Recent Positions -->
    <div class="main-card col-span-8">
      <div class="main-card-header">
        <div class="main-card-title">
          <span>üìà</span>
          <span>Recent Positions</span>
        </div>
        <a href="#" data-page="positions" class="main-card-action"
          >View All ‚Üí</a
        >
      </div>

      <div id="recentPositionsContainer">
        <div class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <div class="empty-state-text">No positions to display</div>
        </div>
      </div>
    </div>

    <!-- System Metrics -->
    <div class="main-card col-span-4">
      <div class="main-card-header">
        <div class="main-card-title">
          <span>‚öôÔ∏è</span>
          <span>System Metrics</span>
        </div>
        <a href="#" data-page="status" class="main-card-action">Details ‚Üí</a>
      </div>

      <div class="metrics-grid">
        <div class="metric-item">
          <div class="metric-item-label">CPU Usage</div>
          <div class="metric-item-value" id="metricCpu">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-item-label">Memory</div>
          <div class="metric-item-value" id="metricMemory">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-item-label">RPC Calls/sec</div>
          <div class="metric-item-value" id="metricRpc">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-item-label">Uptime</div>
          <div class="metric-item-value" id="metricUptime">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-item-label">Services</div>
          <div class="metric-item-value" id="metricServices">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-item-label">Tokens</div>
          <div class="metric-item-value" id="metricTokens">--</div>
        </div>
      </div>
    </div>

    <!-- Trading Config -->
    <div class="main-card col-span-6">
      <div class="main-card-header">
        <div class="main-card-title">
          <span>‚ö°</span>
          <span>Trading Configuration</span>
        </div>
        <a href="#" data-page="config" class="main-card-action">Edit ‚Üí</a>
      </div>

      <div class="metrics-grid">
        <div class="metric-item">
          <div class="metric-item-label">Max Positions</div>
          <div class="metric-item-value" id="configMaxPositions">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-item-label">Trade Size</div>
          <div class="metric-item-value" id="configTradeSize">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-item-label">Stop Loss</div>
          <div class="metric-item-value" id="configStopLoss">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-item-label">Min Profit</div>
          <div class="metric-item-value" id="configMinProfit">--</div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="main-card col-span-6">
      <div class="main-card-header">
        <div class="main-card-title">
          <span>üì°</span>
          <span>Recent Activity</span>
        </div>
        <a href="#" data-page="events" class="main-card-action">View All ‚Üí</a>
      </div>

      <div id="recentActivityContainer" class="activity-feed">
        <div class="empty-state">
          <div class="empty-state-icon">üì°</div>
          <div class="empty-state-text">No recent activity</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const state = {
        pollers: {
          overview: null,
          config: null,
          events: null,
        },
        overview: null,
        config: null,
        status: null,
        positions: [],
        events: [],
        context: null,
        statusCleanup: null,
      };

      // Use Utils.el, Utils.setText, Utils.formatSol, Utils.formatPercent, Utils.formatTimeAgo

      function createFetchOptions() {
        if (
          state.context &&
          typeof state.context.createAbortController === "function"
        ) {
          const controller = state.context.createAbortController();
          return { signal: controller.signal };
        }
        return undefined;
      }

      function updateHeroSection(data) {
        const positions = data?.positions || {};
        const badge = el("heroStatusBadge");
        const statusDot = el("heroStatusDot");
        const statusText = el("heroStatusText");
        const traderActive =
          state.status?.trader?.is_active ??
          state.status?.trader?.active ??
          true;

        if (badge && statusDot && statusText) {
          if (traderActive) {
            badge.className = "hero-status-badge active";
            statusDot.textContent = "‚óè";
            statusText.textContent = "Active";
          } else {
            badge.className = "hero-status-badge inactive";
            statusDot.textContent = "‚óè";
            statusText.textContent = "Stopped";
          }
        }

        const pnl = positions.total_pnl;
        if (Number.isFinite(pnl)) {
          const pnlEl = el("heroPnl");
          if (pnlEl) {
            pnlEl.textContent = `${pnl >= 0 ? "+" : ""}${formatSol(pnl)}`;
            pnlEl.style.color = pnl >= 0 ? "#22c55e" : "#ef4444";
          }

          const changeEl = el("heroPnlChange");
          if (changeEl) {
            const winRate = positions.win_rate;
            changeEl.textContent = `${
              Number.isFinite(winRate) ? winRate.toFixed(1) : 0
            }% win rate`;
            changeEl.className =
              pnl >= 0
                ? "hero-metric-change positive"
                : "hero-metric-change negative";
          }
        }

        const openPos = positions.open_positions || 0;
        setText("heroOpenPositions", openPos);
        setText(
          "heroPositionsInfo",
          `of ${state.config?.trading_limits?.max_open_positions || "--"} max`
        );

        const solBalance = state.status?.wallet?.sol_balance;
        if (Number.isFinite(solBalance)) {
          setText("heroSolBalance", formatSol(solBalance));
          const invested = positions.total_invested_sol || 0;
          setText("heroBalanceChange", `${formatSol(invested)} invested`);
        }

        const winRate = positions.win_rate;
        if (Number.isFinite(winRate)) {
          setText("heroWinRate", formatPercent(winRate));
          const closed = positions.closed_positions || 0;
          setText("heroWinRateInfo", `from ${closed} closed`);
        }
      }

      function updateQuickStats(data) {
        const positions = data?.positions || {};
        const monitoring = data?.monitoring || {};

        const totalTrades = positions.total_positions || 0;
        setText("statTotalTrades", totalTrades);
        const closed = positions.closed_positions || 0;
        setText(
          "statTradesInfo",
          `${closed} closed, ${positions.open_positions || 0} open`
        );

        const invested = positions.total_invested_sol || 0;
        setText("statInvested", formatSol(invested));

        const tracked = monitoring.tokens_tracked || 0;
        setText("statMonitoring", tracked);
        const blacklisted = data?.blacklist?.total_blacklisted || 0;
        setText("statMonitoringInfo", `${blacklisted} blacklisted`);

        const servicesReady = state.status?.services?.all_ready;
        if (servicesReady !== undefined) {
          setText("statHealth", servicesReady ? "Healthy" : "Starting");
          const healthEl = el("statHealth");
          if (healthEl) {
            healthEl.style.color = servicesReady ? "#22c55e" : "#f59e0b";
          }
          setText(
            "statHealthInfo",
            servicesReady ? "All systems operational" : "Services initializing"
          );
        }
      }

      function updateSystemMetrics(snapshot) {
        if (!snapshot) return;

        const metrics = snapshot.metrics || {};

        if (Number.isFinite(metrics.cpu_system_percent)) {
          setText("metricCpu", `${metrics.cpu_system_percent.toFixed(1)}%`);
        }

        if (
          Number.isFinite(metrics.system_memory_used_mb) &&
          Number.isFinite(metrics.system_memory_total_mb)
        ) {
          const used = (metrics.system_memory_used_mb / 1024).toFixed(1);
          const total = (metrics.system_memory_total_mb / 1024).toFixed(1);
          setText("metricMemory", `${used}/${total} GB`);
        }

        const rpcRate = snapshot.rpc_stats?.calls_per_second;
        if (Number.isFinite(rpcRate)) {
          setText("metricRpc", rpcRate.toFixed(1));
        }

        setText("metricUptime", snapshot.uptime_formatted || "--");

        const services = snapshot.services;
        if (services) {
          setText(
            "metricServices",
            `${services.started || 0}/${services.total || 0}`
          );
        }

        if (snapshot.wallet) {
          setText("metricTokens", snapshot.wallet.total_tokens_count || 0);
        }
      }

      function updateTradingConfig(config) {
        if (!config) return;

        const limits = config.trading_limits || {};
        const risk = config.risk_management || {};
        const targets = config.profit_targets || {};

        setText("configMaxPositions", limits.max_open_positions || "--");
        setText("configTradeSize", formatSol(limits.trade_size_sol));
        setText("configStopLoss", `${risk.stop_loss_percent || "--"}%`);
        setText(
          "configMinProfit",
          `${targets.base_min_profit_percent || "--"}%`
        );
      }

      function renderRecentPositions(positions) {
        const container = el("recentPositionsContainer");
        if (!container) return;

        if (!positions || positions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìä</div>
              <div class="empty-state-text">No open positions</div>
            </div>
          `;
          return;
        }

        const rows = positions.slice(0, 5).map((pos) => {
          const pnlPercent = pos.pnl_percent || 0;
          const pnlColor = pnlPercent >= 0 ? "#22c55e" : "#ef4444";
          const holdMinutes = pos.hold_duration_minutes || 0;
          const holdHours = Math.floor(holdMinutes / 60);
          const holdMins = holdMinutes % 60;
          const holdStr =
            holdHours > 0 ? `${holdHours}h ${holdMins}m` : `${holdMins}m`;

          return `
            <tr>
              <td><span class="token-symbol">${
                pos.symbol || "Unknown"
              }</span></td>
              <td>${formatSol(pos.entry_price)}</td>
              <td>${
                pos.current_price ? formatSol(pos.current_price) : "--"
              }</td>
              <td style="color: ${pnlColor}; font-weight: 600;">${
            pnlPercent >= 0 ? "+" : ""
          }${pnlPercent.toFixed(2)}%</td>
              <td>${holdStr}</td>
            </tr>
          `;
        });

        container.innerHTML = `
          <table class="positions-table">
            <thead>
              <tr>
                <th>Token</th>
                <th>Entry Price</th>
                <th>Current Price</th>
                <th>P&L %</th>
                <th>Hold Time</th>
              </tr>
            </thead>
            <tbody>
              ${rows.join("")}
            </tbody>
          </table>
        `;
      }

      function renderRecentActivity(events) {
        const container = el("recentActivityContainer");
        if (!container) return;

        if (!events || events.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì°</div>
              <div class="empty-state-text">No recent activity</div>
            </div>
          `;
          return;
        }

        const items = events.slice(0, 8).map((event) => {
          let iconClass = "info";
          let icon = "‚ÑπÔ∏è";
          const eventType = event.event_type || event.category || "SYSTEM";

          if (eventType === "POSITION_OPEN") {
            iconClass = "success";
            icon = "üìà";
          } else if (eventType === "POSITION_CLOSE") {
            iconClass = event.is_profitable ? "success" : "error";
            icon = event.is_profitable ? "‚úÖ" : "‚ùå";
          } else if (event.severity === "ERROR" || event.level === "error") {
            iconClass = "error";
            icon = "‚ö†Ô∏è";
          }

          const title = eventType.replace(/_/g, " ");

          return `
            <div class="activity-item">
              <div class="activity-icon ${iconClass}">${icon}</div>
              <div class="activity-content">
                <div class="activity-title">${title}</div>
                <div class="activity-description">${
                  event.message || event.description || "--"
                }</div>
                <div class="activity-time">${formatTime(
                  event.timestamp || event.created_at
                )}</div>
              </div>
            </div>
          `;
        });

        container.innerHTML = items.join("");
      }

      function handleStatusSnapshot(snapshot) {
        state.status = snapshot;
        updateSystemMetrics(snapshot);
        if (state.overview) {
          updateHeroSection(state.overview);
        }
      }

      async function fetchOverview() {
        try {
          const options = createFetchOptions();
          const res = await fetch("/api/dashboard/overview", options);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          state.overview = data;
          updateHeroSection(data);
          updateQuickStats(data);

          if (data.positions && data.positions.open_position_details) {
            state.positions = data.positions.open_position_details;
            renderRecentPositions(state.positions);
          }
        } catch (error) {
          if (error?.name === "AbortError") {
            return;
          }
          console.error("[Home] Failed to fetch overview:", error);
        }
      }

      async function fetchConfig() {
        try {
          const options = createFetchOptions();
          const res = await fetch("/api/trading/config", options);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          state.config = data;
          updateTradingConfig(data);
          if (state.overview) {
            updateHeroSection(state.overview);
          }
        } catch (error) {
          if (error?.name === "AbortError") {
            return;
          }
          console.error("[Home] Failed to fetch config:", error);
        }
      }

      async function fetchRecentEvents() {
        try {
          const options = createFetchOptions();
          const res = await fetch("/api/events/head?count=8", options);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          state.events = data.events || [];
          renderRecentActivity(state.events);
        } catch (error) {
          if (error?.name === "AbortError") {
            return;
          }
          console.error("[Home] Failed to fetch events:", error);
        }
      }

      function ensurePollers(context) {
        const enlist =
          context && typeof context.managePoller === "function"
            ? (poller) => context.managePoller(poller)
            : (poller) => poller;

        if (!state.pollers.overview) {
          state.pollers.overview = enlist(
            PagePoller.create({
              label: "HomeOverview",
              onPoll: fetchOverview,
            })
          );
        }

        if (!state.pollers.config) {
          state.pollers.config = enlist(
            PagePoller.create({
              label: "HomeConfig",
              onPoll: fetchConfig,
              getInterval: () => {
                const base = window.PollingManager?.getInterval() || 1000;
                return Math.min(base * 60, 60000);
              },
            })
          );
        }

        if (!state.pollers.events) {
          state.pollers.events = enlist(
            PagePoller.create({
              label: "HomeEvents",
              onPoll: fetchRecentEvents,
              getInterval: () => {
                const base = window.PollingManager?.getInterval() || 1000;
                return Math.max(base * 2, 2000);
              },
            })
          );
        }
      }

      function forEachPoller(callback) {
        Object.keys(state.pollers).forEach((key) => {
          const poller = state.pollers[key];
          if (poller) {
            callback(poller, key);
          }
        });
      }

      function startPollers() {
        forEachPoller((poller) => {
          if (typeof poller.start === "function") {
            poller.start();
          }
        });
      }

      function stopPollers() {
        forEachPoller((poller) => {
          if (typeof poller.stop === "function") {
            poller.stop({ silent: true });
          }
        });
      }

      function cleanupPollers() {
        forEachPoller((poller, key) => {
          if (typeof poller.cleanup === "function") {
            poller.cleanup();
          }
          state.pollers[key] = null;
        });
      }

      function subscribeToStatus(context) {
        if (!window.StatusService || state.statusCleanup) {
          return;
        }

        let unsubscribe = null;

        if (typeof window.StatusService.addListener === "function") {
          try {
            const result =
              window.StatusService.addListener(handleStatusSnapshot);
            if (typeof result === "function") {
              unsubscribe = result;
            }
          } catch (error) {
            console.error(
              "[Home] Failed to attach StatusService listener",
              error
            );
          }
        }

        if (
          !unsubscribe &&
          typeof window.StatusService.removeListener === "function"
        ) {
          unsubscribe = () => {
            try {
              window.StatusService.removeListener(handleStatusSnapshot);
            } catch (error) {
              console.error(
                "[Home] Failed to remove StatusService listener",
                error
              );
            }
          };
        }

        if (!unsubscribe) {
          return;
        }

        state.statusCleanup = () => {
          try {
            unsubscribe();
          } catch (error) {
            console.error("[Home] StatusService unsubscribe failed", error);
          } finally {
            state.statusCleanup = null;
          }
        };

        context.onDispose(() => {
          if (state.statusCleanup) {
            state.statusCleanup();
          }
        });
      }

      function createHomePageLifecycle() {
        return {
          init(context) {
            state.context = context;
            context.data.state = state;
            subscribeToStatus(context);
          },
          activate(context) {
            ensurePollers(context);
            startPollers();
            fetchOverview();
            fetchConfig();
            fetchRecentEvents();
          },
          deactivate() {
            stopPollers();
          },
          dispose() {
            cleanupPollers();
            if (state.statusCleanup) {
              state.statusCleanup();
              state.statusCleanup = null;
            }
            state.context = null;
            state.status = null;
          },
        };
      }

      if (window.PageLifecycleRegistry) {
        window.PageLifecycleRegistry.register(
          "home",
          createHomePageLifecycle()
        );
      } else {
        if (!window.__pendingPageRegistrations) {
          window.__pendingPageRegistrations = [];
        }
        window.__pendingPageRegistrations.push({
          pageId: "home",
          lifecycle: createHomePageLifecycle(),
        });
      }
    })();
  </script>
</div>
