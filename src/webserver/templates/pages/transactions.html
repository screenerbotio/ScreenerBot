<div class="page-table">
  <style>
    .transactions-toolbar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-card);
    }

    .transactions-toolbar .toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 16px;
      align-items: center;
    }

    .transactions-toolbar .toolbar-row-head {
      justify-content: space-between;
    }

    .transactions-toolbar .toolbar-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 200px;
    }

    .transactions-toolbar .toolbar-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .transactions-toolbar .toolbar-meta {
      color: var(--text-muted);
      font-size: 0.85em;
    }

    .transactions-toolbar .toolbar-actions {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-left: auto;
    }

    .transactions-toolbar .filter-row {
      align-items: flex-start;
    }

    .transactions-toolbar .filter-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 160px;
    }

    .transactions-toolbar .filter-section.stretch {
      flex: 1 1 240px;
    }

    .transactions-toolbar .filter-label {
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .transactions-toolbar .filter-chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .transactions-toolbar .filter-chip {
      padding: 4px 10px;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .transactions-toolbar .filter-chip.active {
      background: var(--link-color);
      border-color: var(--link-color);
      color: #fff;
    }

    .transactions-toolbar .filter-chip:not(.active):hover,
    .transactions-toolbar .filter-chip:not(.active):focus {
      border-color: var(--link-color);
      color: var(--link-color);
      outline: none;
    }

    .transactions-toolbar .filter-input {
      display: flex;
      align-items: center;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
    }

    .transactions-toolbar .filter-input input {
      flex: 1;
      border: none;
      background: transparent;
      padding: 6px 10px;
      color: var(--text-primary);
    }

    .transactions-toolbar .filter-input .input-clear {
      border: none;
      background: transparent;
      color: var(--text-muted);
      padding: 0 10px;
      cursor: pointer;
      font-size: 0.9em;
    }

    .transactions-toolbar .filter-input .input-clear:hover,
    .transactions-toolbar .filter-input .input-clear:focus {
      color: var(--text-primary);
    }

    .transactions-toolbar .advanced-toggle {
      justify-content: flex-start;
    }

    .transactions-toolbar .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .transactions-toolbar .advanced-panel[data-expanded="false"] {
      display: none;
    }

    .transactions-toolbar .advanced-panel {
      border-top: 1px dashed var(--border-color);
      padding-top: 12px;
    }

    .transactions-toolbar .date-range-inputs {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .transactions-toolbar .date-range-inputs input {
      width: 180px;
    }

    .transactions-toolbar .range-separator {
      color: var(--text-muted);
      font-size: 0.85em;
    }

    .transactions-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .transactions-summary-card {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-card);
    }

    .transactions-summary-card .summary-label {
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .transactions-summary-card .summary-value {
      font-family: var(
        --font-mono,
        "SFMono-Regular",
        Menlo,
        Monaco,
        Consolas,
        "Liberation Mono",
        "Courier New",
        monospace
      );
      font-size: 1.2em;
      color: var(--text-primary);
    }

    .transactions-summary-card .summary-subvalue {
      color: var(--text-secondary);
      font-size: 0.85em;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .transactions-summary-card .summary-subvalue code {
      font-size: 0.95em;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-secondary);
      background: var(--bg-primary);
    }

    .pill-status-confirmed,
    .pill-status-finalized {
      border-color: var(--badge-online);
      color: var(--badge-online);
    }

    .pill-status-pending {
      border-color: var(--badge-loading);
      color: var(--badge-loading);
    }

    .pill-status-failed {
      border-color: var(--badge-error);
      color: var(--badge-error);
    }

    .pill-direction-incoming {
      border-color: var(--badge-online);
      color: var(--badge-online);
    }

    .pill-direction-outgoing {
      border-color: var(--badge-error);
      color: var(--badge-error);
    }

    .pill-direction-internal {
      border-color: var(--text-secondary);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--badge-online);
      font-weight: 600;
    }

    .value-negative {
      color: var(--badge-error);
      font-weight: 600;
    }

    .scroll-guard-cell {
      color: var(--text-secondary);
      font-size: 0.9em;
      padding: 18px;
    }

    .scroll-guard-cell.loading {
      color: var(--text-muted);
    }
  </style>
  <div class="toolbar transactions-toolbar">
    <div class="toolbar-row toolbar-row-head">
      <div class="toolbar-title-block">
        <span class="toolbar-title">ðŸ’± Transactions</span>
        <span id="tx-summary" class="toolbar-meta"></span>
      </div>
      <div class="toolbar-actions">
        <span id="tx-last-updated" class="toolbar-meta">Last update â€”</span>
        <button id="tx-apply-filters" class="btn btn-primary" type="button">
          Apply Filters
        </button>
        <button id="tx-reset-filters" class="btn" type="button">Reset</button>
      </div>
    </div>

    <div class="toolbar-row filter-row">
      <div class="filter-section">
        <span class="filter-label">Type</span>
        <div
          class="filter-chip-group"
          data-filter-group="type"
          data-multi="true"
        >
          <button class="filter-chip active" data-value="all" type="button">
            All
          </button>
          <button class="filter-chip" data-value="buy" type="button">
            Buy
          </button>
          <button class="filter-chip" data-value="sell" type="button">
            Sell
          </button>
          <button class="filter-chip" data-value="swap" type="button">
            Swap
          </button>
          <button class="filter-chip" data-value="transfer" type="button">
            Transfer
          </button>
          <button class="filter-chip" data-value="ata" type="button">
            ATA
          </button>
          <button class="filter-chip" data-value="failed" type="button">
            Failed
          </button>
          <button class="filter-chip" data-value="unknown" type="button">
            Unknown
          </button>
        </div>
      </div>

      <div class="filter-section">
        <span class="filter-label">Direction</span>
        <div class="filter-chip-group" data-filter-group="direction">
          <button class="filter-chip active" data-value="all" type="button">
            All
          </button>
          <button class="filter-chip" data-value="Incoming" type="button">
            Incoming
          </button>
          <button class="filter-chip" data-value="Outgoing" type="button">
            Outgoing
          </button>
          <button class="filter-chip" data-value="Internal" type="button">
            Internal
          </button>
          <button class="filter-chip" data-value="Unknown" type="button">
            Unknown
          </button>
        </div>
      </div>

      <div class="filter-section">
        <span class="filter-label">Status</span>
        <div class="filter-chip-group" data-filter-group="status">
          <button class="filter-chip active" data-value="all" type="button">
            All
          </button>
          <button class="filter-chip" data-value="Pending" type="button">
            Pending
          </button>
          <button class="filter-chip" data-value="Confirmed" type="button">
            Confirmed
          </button>
          <button class="filter-chip" data-value="Finalized" type="button">
            Finalized
          </button>
          <button class="filter-chip" data-value="Failed" type="button">
            Failed
          </button>
        </div>
      </div>

      <div class="filter-section stretch">
        <span class="filter-label">Signature</span>
        <div class="filter-input">
          <input
            type="text"
            id="tx-filter-signature"
            placeholder="Signature contains..."
            autocomplete="off"
          />
          <button
            class="input-clear"
            type="button"
            id="tx-clear-signature"
            title="Clear signature filter"
            aria-label="Clear signature filter"
          >
            âœ•
          </button>
        </div>
      </div>
    </div>

    <div class="toolbar-row advanced-toggle">
      <button class="btn btn-ghost" type="button" id="tx-toggle-advanced">
        <span class="toggle-icon">â–¼</span>
        Advanced filters
      </button>
    </div>

    <div
      class="toolbar-row advanced-panel"
      id="tx-advanced-filters"
      data-expanded="false"
    >
      <div class="filter-section">
        <span class="filter-label">Router</span>
        <input
          type="text"
          id="tx-filter-router"
          placeholder="Router (jupiter, raydium...)"
          autocomplete="off"
        />
      </div>
      <div class="filter-section">
        <span class="filter-label">Token Mint</span>
        <input
          type="text"
          id="tx-filter-mint"
          placeholder="Token mint..."
          autocomplete="off"
        />
      </div>
      <div class="filter-section date-range">
        <span class="filter-label">Time Range</span>
        <div class="date-range-inputs">
          <input type="datetime-local" id="tx-filter-from" />
          <span class="range-separator">â†’</span>
          <input type="datetime-local" id="tx-filter-to" />
        </div>
      </div>
      <div class="filter-section">
        <span class="filter-label">Min SOL Î”</span>
        <input
          type="number"
          step="0.0001"
          id="tx-filter-min-sol"
          placeholder="Min SOL"
        />
      </div>
      <div class="filter-section">
        <span class="filter-label">Max SOL Î”</span>
        <input
          type="number"
          step="0.0001"
          id="tx-filter-max-sol"
          placeholder="Max SOL"
        />
      </div>
    </div>
  </div>
  <div class="transactions-summary-grid" id="tx-summary-cards">
    <div class="transactions-summary-card">
      <div class="summary-label">Processed</div>
      <div class="summary-value" id="tx-stat-total">â€”</div>
      <div class="summary-subvalue">
        <span><span id="tx-stat-success">â€”</span> success</span>
        <span>â€¢</span>
        <span><span id="tx-stat-failed">â€”</span> failed</span>
      </div>
      <div class="summary-subvalue" id="tx-stat-success-rate">
        Success â€” â€¢ Fail â€”
      </div>
    </div>
    <div class="transactions-summary-card">
      <div class="summary-label">Queues</div>
      <div class="summary-value" id="tx-stat-pending-global">â€”</div>
      <div class="summary-subvalue">
        <span>Local</span>
        <span id="tx-stat-pending-local">â€”</span>
      </div>
      <div class="summary-subvalue">
        <span>Deferred</span>
        <span id="tx-stat-deferred">â€”</span>
      </div>
    </div>
    <div class="transactions-summary-card">
      <div class="summary-label">Database</div>
      <div class="summary-value" id="tx-stat-db-size">â€”</div>
      <div class="summary-subvalue">
        <span>Schema</span>
        <span id="tx-stat-schema">â€”</span>
      </div>
      <div class="summary-subvalue">
        <span>Loaded</span>
        <span id="tx-stat-loaded">â€”</span>
      </div>
    </div>
    <div class="transactions-summary-card">
      <div class="summary-label">Known Signatures</div>
      <div class="summary-value" id="tx-stat-newest-sig">â€”</div>
      <div class="summary-subvalue">
        <span>Oldest</span>
        <span id="tx-stat-oldest-sig">â€”</span>
      </div>
      <div class="summary-subvalue">
        <span id="tx-stat-bootstrap-status">Bootstrap â€”</span>
        <span id="tx-stat-bootstrap-cursor"></span>
      </div>
    </div>
  </div>
  <div class="table-wrap">
    <table class="table" id="tx-table">
      <thead>
        <tr>
          <th style="min-width: 150px">Date / Time</th>
          <th style="min-width: 140px">Signature</th>
          <th style="min-width: 80px">Type</th>
          <th style="min-width: 80px">Direction</th>
          <th style="min-width: 80px">Status</th>
          <th style="min-width: 120px">Mint</th>
          <th style="min-width: 100px">Router</th>
          <th style="min-width: 100px">SOL Î”</th>
          <th style="min-width: 90px">Fee</th>
          <th style="min-width: 90px">ATA Rent</th>
          <th style="min-width: 60px">Instr</th>
        </tr>
      </thead>
      <tbody id="tx-tbody">
        <tr>
          <td colspan="11" style="text-align: center; padding: 40px">
            Loading transactions...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <script>
    (function () {
      function toRfc3339Local(dtInput) {
        if (!dtInput || !dtInput.value) return null;
        try {
          const d = new Date(dtInput.value);
          return d.toISOString();
        } catch (_) {
          return null;
        }
      }

      function el(id) {
        return document.getElementById(id);
      }

      function qs(selector, scope = document) {
        return scope.querySelector(selector);
      }

      function qsa(selector, scope = document) {
        return Array.from(scope.querySelectorAll(selector));
      }

      function textFromInput(id) {
        const input = el(id);
        if (!input) return null;
        const value = input.value.trim();
        return value ? value : null;
      }

      function numberFromInput(id) {
        const input = el(id);
        if (!input) return null;
        const raw = input.value.trim();
        if (raw === "") return null;
        const parsed = parseFloat(raw);
        return Number.isFinite(parsed) ? parsed : null;
      }

      const dateTimeFormatter = new Intl.DateTimeFormat(undefined, {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });

      function escapeHtml(value) {
        if (value === null || value === undefined) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function toSlug(value) {
        if (!value) return "";
        return String(value)
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
      }

      function formatSignatureCompact(signature, options) {
        if (!signature) return "â€”";
        const start = options?.start ?? 6;
        const end = options?.end ?? 6;
        if (signature.length <= start + end + 1) {
          return signature;
        }
        return `${signature.slice(0, start)}â€¦${signature.slice(-end)}`;
      }

      function formatNumber(value, decimals = 0, fallback = "0") {
        const num = Number(value);
        if (!Number.isFinite(num)) {
          return fallback;
        }
        if (window.Utils && typeof Utils.formatNumber === "function") {
          return Utils.formatNumber(num, decimals, { fallback });
        }
        try {
          return num.toLocaleString(undefined, {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
          });
        } catch (_) {
          return fallback;
        }
      }

      function formatRate(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return "â€”";
        return `${num.toFixed(1)}%`;
      }

      function formatSol(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return "0.0000";
        const magnitude = Math.abs(num);
        const decimals = magnitude >= 1 ? 4 : 6;
        const formatted = magnitude.toLocaleString(undefined, {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
        });
        if (num > 0) return `+${formatted}`;
        if (num < 0) return `-${formatted}`;
        return formatted;
      }

      function renderPill(label, prefix) {
        if (!label || label === "â€”") return "â€”";
        const slug = toSlug(label);
        const className = slug ? `${prefix}-${slug}` : "";
        return `<span class="pill ${className}">${escapeHtml(label)}</span>`;
      }

      function formatRelativeTime(date) {
        if (!date) return null;
        if (window.Utils && typeof Utils.formatTimeAgo === "function") {
          return Utils.formatTimeAgo(date, { fallback: "just now" });
        }
        const diffMs = Date.now() - date.getTime();
        if (!Number.isFinite(diffMs)) return null;
        const seconds = Math.max(0, Math.round(diffMs / 1000));
        if (seconds < 60) return "just now";
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
      }

      function formatTimestampDisplay(date) {
        if (!date) return "";
        if (window.Utils && typeof Utils.formatTimestamp === "function") {
          return Utils.formatTimestamp(date, { includeSeconds: true });
        }
        try {
          return date.toLocaleString();
        } catch (_) {
          return date.toISOString();
        }
      }

      function updateLastUpdatedLabel() {
        const label = el("tx-last-updated");
        if (!label) return;
        if (!State.lastUpdatedAt) {
          label.textContent = "Last update â€”";
          label.title = "";
          return;
        }
        const date = new Date(State.lastUpdatedAt);
        const relative = formatRelativeTime(date) || "just now";
        label.textContent = `Last update ${relative}`;
        label.title = formatTimestampDisplay(date);
      }

      function ensureLastUpdatedTicker() {
        if (Lifecycle.statusIntervalId) return;
        const intervalId = setInterval(updateLastUpdatedLabel, 30_000);
        Lifecycle.statusIntervalId = intervalId;
        if (window.Router && typeof Router.trackInterval === "function") {
          Router.trackInterval(intervalId);
        }
      }

      function clearLastUpdatedTicker() {
        if (!Lifecycle.statusIntervalId) return;
        clearInterval(Lifecycle.statusIntervalId);
        Lifecycle.statusIntervalId = null;
      }

      function markLastUpdated() {
        State.lastUpdatedAt = Date.now();
        updateLastUpdatedLabel();
        ensureLastUpdatedTicker();
      }

      function updateSummaryCards(summary) {
        const totalEl = el("tx-stat-total");
        if (!totalEl) return;

        if (!summary) {
          totalEl.textContent = "â€”";
          const successEl = el("tx-stat-success");
          const failedEl = el("tx-stat-failed");
          const rateEl = el("tx-stat-success-rate");
          const pendingGlobalEl = el("tx-stat-pending-global");
          const pendingLocalEl = el("tx-stat-pending-local");
          const deferredEl = el("tx-stat-deferred");
          const sizeEl = el("tx-stat-db-size");
          const schemaEl = el("tx-stat-schema");
          const loadedEl = el("tx-stat-loaded");
          const newestEl = el("tx-stat-newest-sig");
          const oldestEl = el("tx-stat-oldest-sig");
          const bootstrapStatusEl = el("tx-stat-bootstrap-status");
          const bootstrapCursorEl = el("tx-stat-bootstrap-cursor");
          if (successEl) successEl.textContent = "â€”";
          if (failedEl) failedEl.textContent = "â€”";
          if (rateEl) rateEl.textContent = "Success â€” â€¢ Fail â€”";
          if (pendingGlobalEl) pendingGlobalEl.textContent = "â€”";
          if (pendingLocalEl) pendingLocalEl.textContent = "â€”";
          if (deferredEl) deferredEl.textContent = "â€”";
          if (sizeEl) sizeEl.textContent = "â€”";
          if (schemaEl) schemaEl.textContent = "â€”";
          if (loadedEl)
            loadedEl.textContent = formatNumber(State.items.length, 0, "0");
          if (newestEl) newestEl.innerHTML = "â€”";
          if (oldestEl) oldestEl.innerHTML = "â€”";
          if (bootstrapStatusEl) bootstrapStatusEl.textContent = "Bootstrap â€”";
          if (bootstrapCursorEl) bootstrapCursorEl.innerHTML = "";
          return;
        }

        const successEl = el("tx-stat-success");
        const failedEl = el("tx-stat-failed");
        const rateEl = el("tx-stat-success-rate");
        const pendingGlobalEl = el("tx-stat-pending-global");
        const pendingLocalEl = el("tx-stat-pending-local");
        const deferredEl = el("tx-stat-deferred");
        const sizeEl = el("tx-stat-db-size");
        const schemaEl = el("tx-stat-schema");
        const loadedEl = el("tx-stat-loaded");
        const newestEl = el("tx-stat-newest-sig");
        const oldestEl = el("tx-stat-oldest-sig");
        const bootstrapStatusEl = el("tx-stat-bootstrap-status");
        const bootstrapCursorEl = el("tx-stat-bootstrap-cursor");

        totalEl.textContent = formatNumber(summary.total || 0, 0, "0");
        if (successEl) {
          successEl.textContent = formatNumber(
            summary.success_count || 0,
            0,
            "0"
          );
        }
        if (failedEl) {
          failedEl.textContent = formatNumber(
            summary.failed_count || 0,
            0,
            "0"
          );
        }
        if (rateEl) {
          rateEl.textContent = `Success ${formatRate(
            summary.success_rate
          )} â€¢ Fail ${formatRate(summary.failure_rate)}`;
        }
        if (pendingGlobalEl) {
          pendingGlobalEl.textContent = formatNumber(
            summary.pending_global || 0,
            0,
            "0"
          );
        }
        if (pendingLocalEl) {
          pendingLocalEl.textContent = formatNumber(
            summary.pending_local || 0,
            0,
            "0"
          );
        }
        if (deferredEl) {
          deferredEl.textContent = formatNumber(
            summary.deferred_count || 0,
            0,
            "0"
          );
        }
        if (sizeEl) {
          sizeEl.textContent = `${formatNumber(
            summary.db_size_mb || 0,
            2,
            "0.00"
          )} MB`;
        }
        if (schemaEl) {
          schemaEl.textContent = summary.db_schema_version
            ? `v${summary.db_schema_version}`
            : "â€”";
        }
        if (loadedEl) {
          loadedEl.textContent = formatNumber(State.items.length, 0, "0");
        }
        if (newestEl) {
          if (summary.newest_known_signature) {
            const sig = summary.newest_known_signature;
            newestEl.innerHTML = `<code title="${escapeHtml(sig)}">${escapeHtml(
              formatSignatureCompact(sig, { start: 6, end: 6 })
            )}</code>`;
          } else {
            newestEl.innerHTML = "â€”";
          }
        }
        if (oldestEl) {
          if (summary.oldest_known_signature) {
            const sig = summary.oldest_known_signature;
            oldestEl.innerHTML = `<code title="${escapeHtml(sig)}">${escapeHtml(
              formatSignatureCompact(sig, { start: 6, end: 6 })
            )}</code>`;
          } else {
            oldestEl.innerHTML = "â€”";
          }
        }
        if (bootstrapStatusEl) {
          bootstrapStatusEl.textContent = summary.bootstrap_state
            ?.full_history_completed
            ? "Bootstrap Completed"
            : "Bootstrap In Progress";
        }
        if (bootstrapCursorEl) {
          const cursor = summary.bootstrap_state?.backfill_cursor;
          if (cursor) {
            bootstrapCursorEl.innerHTML = `<code title="${escapeHtml(
              cursor
            )}">${escapeHtml(
              formatSignatureCompact(cursor, { start: 6, end: 6 })
            )}</code>`;
          } else {
            bootstrapCursorEl.innerHTML = "";
          }
        }
      }

      function registerLifecycleCleanup() {
        if (
          !window.Router ||
          typeof Router.registerCleanup !== "function" ||
          Lifecycle.cleanupRegistered
        ) {
          return;
        }
        Router.registerCleanup(() => {
          teardownTransactionsPage();
        });
        Lifecycle.cleanupRegistered = true;
      }

      function teardownTransactionsPage() {
        clearLastUpdatedTicker();
        State.lastUpdatedAt = null;
        updateLastUpdatedLabel();
        if (State.scrollObserver) {
          State.scrollObserver.disconnect();
          State.scrollObserver = null;
        }
        State.scrollContainer = null;
        Lifecycle.cleanupRegistered = false;
      }

      function renderRow(row) {
        const tr = document.createElement("tr");
        const timestamp = new Date(row.timestamp);
        const dateTime = dateTimeFormatter.format(timestamp);
        const signature = row.signature || "";
        const signatureDisplay = signature
          ? formatSignatureCompact(signature, { start: 8, end: 6 })
          : "â€”";
        const type = row.type || row.transaction_type || "â€”";
        const dir = row.direction || "â€”";
        const status = row.status || "â€”";
        const mintFull = row.token_mint || "";
        const mintDisplay = mintFull
          ? formatSignatureCompact(mintFull, { start: 4, end: 5 })
          : "â€”";
        const router = row.router || "â€”";
        const solDelta = Number(row.sol_delta ?? 0);
        const fee = Number(row.fee_sol ?? 0);
        const ata = Number(row.ata_rents ?? 0);
        const instr = Number.isFinite(row.instructions_count)
          ? row.instructions_count
          : 0;
        const solClass =
          solDelta > 0
            ? "monospace value-positive"
            : solDelta < 0
            ? "monospace value-negative"
            : "monospace";

        tr.innerHTML = `
          <td title="${escapeHtml(timestamp.toLocaleString())}">${escapeHtml(
          dateTime
        )}</td>
          <td>
            ${
              signature
                ? `<a href="#" data-signature="${escapeHtml(
                    signature
                  )}" class="tx-link" title="${escapeHtml(
                    signature
                  )}">${escapeHtml(signatureDisplay)}</a>`
                : "â€”"
            }
          </td>
          <td>${
            type && type !== "â€”"
              ? `<span class="pill">${escapeHtml(type)}</span>`
              : "â€”"
          }</td>
          <td>${
            dir && dir !== "â€”" ? renderPill(dir, "pill-direction") : "â€”"
          }</td>
          <td>${
            status && status !== "â€”" ? renderPill(status, "pill-status") : "â€”"
          }</td>
          <td title="${escapeHtml(mintFull)}">
            ${mintFull ? `<code>${escapeHtml(mintDisplay)}</code>` : "â€”"}
          </td>
          <td>${router && router !== "â€”" ? escapeHtml(router) : "â€”"}</td>
          <td class="${solClass}">${escapeHtml(formatSol(solDelta))}</td>
          <td class="monospace">${escapeHtml(
            formatNumber(fee, 6, "0.000000")
          )}</td>
          <td class="monospace">${escapeHtml(
            formatNumber(ata, 6, "0.000000")
          )}</td>
          <td>${escapeHtml(String(instr))}</td>
        `;
        return tr;
      }

      function getChipGroups() {
        return qsa(".filter-chip-group");
      }

      function setChipActive(btn, active) {
        if (!btn) return;
        btn.classList.toggle("active", !!active);
        btn.setAttribute("aria-pressed", !!active ? "true" : "false");
      }

      function resetGroupToAll(group) {
        if (!group) return;
        const buttons = qsa(".filter-chip", group);
        buttons.forEach((btn) => {
          const isAll = btn.dataset.value === "all";
          setChipActive(btn, isAll);
        });
      }

      function handleMultiChip(group, target) {
        const value = target.dataset.value;
        const buttons = qsa(".filter-chip", group);
        const allButton = buttons.find((btn) => btn.dataset.value === "all");

        if (value === "all") {
          resetGroupToAll(group);
          return;
        }

        const nowActive = !target.classList.contains("active");
        setChipActive(target, nowActive);

        if (nowActive) {
          if (allButton) setChipActive(allButton, false);
        } else {
          const stillActive = buttons.some(
            (btn) => btn !== allButton && btn.classList.contains("active")
          );
          if (!stillActive) {
            resetGroupToAll(group);
          }
        }
      }

      function handleSingleChip(group, target) {
        const buttons = qsa(".filter-chip", group);
        buttons.forEach((btn) => setChipActive(btn, btn === target));
      }

      function initChipGroups() {
        getChipGroups().forEach((group) => {
          const isMulti = group.dataset.multi === "true";
          qsa(".filter-chip", group).forEach((btn) => {
            if (!btn.dataset.value) return;
            btn.setAttribute(
              "aria-pressed",
              btn.classList.contains("active") ? "true" : "false"
            );
            if (btn.__chipListenerAttached) return;
            btn.addEventListener("click", () => {
              if (isMulti) {
                handleMultiChip(group, btn);
              } else {
                handleSingleChip(group, btn);
              }
              updateFilterMeta();
            });
            btn.__chipListenerAttached = true;
          });
        });
      }

      function getGroupValues(groupName) {
        const group = qs(
          `.filter-chip-group[data-filter-group="${groupName}"]`
        );
        if (!group) return groupName === "type" ? [] : null;
        const isMulti = group.dataset.multi === "true";
        const activeButtons = qsa(".filter-chip.active", group).map(
          (btn) => btn.dataset.value
        );
        if (isMulti) {
          return activeButtons.includes("all") ? [] : activeButtons;
        }
        const value = activeButtons[0] || "all";
        return value === "all" ? null : value;
      }

      function setGroupValues(groupName, values) {
        const group = qs(
          `.filter-chip-group[data-filter-group="${groupName}"]`
        );
        if (!group) return;
        const isMulti = group.dataset.multi === "true";
        const buttons = qsa(".filter-chip", group);
        if (isMulti) {
          const normalized = Array.isArray(values)
            ? values.filter(Boolean)
            : [];
          const valueSet = new Set(normalized);
          buttons.forEach((btn) => {
            const val = btn.dataset.value;
            if (val === "all") {
              setChipActive(btn, valueSet.size === 0);
            } else {
              setChipActive(btn, valueSet.size > 0 ? valueSet.has(val) : false);
            }
          });
          const anyActive = buttons.some(
            (btn) =>
              btn.dataset.value !== "all" && btn.classList.contains("active")
          );
          if (!anyActive) resetGroupToAll(group);
        } else {
          const normalized = values || "all";
          buttons.forEach((btn) => {
            const shouldActive = btn.dataset.value === normalized;
            setChipActive(btn, shouldActive);
          });
          if (!buttons.some((btn) => btn.classList.contains("active"))) {
            resetGroupToAll(group);
          }
        }
      }

      function buildFilters() {
        const selectedTypes = getGroupValues("type");
        const direction = getGroupValues("direction");
        const status = getGroupValues("status");
        const router = textFromInput("tx-filter-router");
        const mint = textFromInput("tx-filter-mint");
        const signature = textFromInput("tx-filter-signature");
        const min_sol = numberFromInput("tx-filter-min-sol");
        const max_sol = numberFromInput("tx-filter-max-sol");
        const time_from = toRfc3339Local(el("tx-filter-from"));
        const time_to = toRfc3339Local(el("tx-filter-to"));
        return {
          types: selectedTypes,
          direction,
          status,
          signature,
          router,
          mint,
          min_sol,
          max_sol,
          time_from,
          time_to,
        };
      }

      function countActiveFilters(filters) {
        if (!filters) return 0;
        let count = 0;
        if (filters.types && filters.types.length) count += 1;
        if (filters.direction) count += 1;
        if (filters.status) count += 1;
        if (filters.signature) count += 1;
        if (filters.router) count += 1;
        if (filters.mint) count += 1;
        const hasMin =
          filters.min_sol !== null && filters.min_sol !== undefined;
        const hasMax =
          filters.max_sol !== null && filters.max_sol !== undefined;
        if (hasMin || hasMax) count += 1;
        if (filters.time_from || filters.time_to) count += 1;
        return count;
      }

      function updateFilterMeta() {
        const current = buildFilters();
        const count = countActiveFilters(current);
        const metaEl = el("tx-summary");
        if (!metaEl) return;
        const summaryText = metaEl.dataset.summaryText || "";
        let finalText = summaryText;
        if (count > 0) {
          const filtersLabel = `${count} filter${
            count === 1 ? "" : "s"
          } active`;
          finalText = summaryText
            ? `${summaryText} â€¢ ${filtersLabel}`
            : filtersLabel;
        }
        metaEl.textContent = finalText || summaryText;
      }

      function applySavedFilters() {
        const savedFilters = AppState.load("tx.filters", null);
        if (savedFilters) {
          setGroupValues("type", savedFilters.types || []);
          setGroupValues("direction", savedFilters.direction || null);
          setGroupValues("status", savedFilters.status || null);
          el("tx-filter-router").value = savedFilters.router || "";
          el("tx-filter-mint").value = savedFilters.mint || "";
          el("tx-filter-signature").value = savedFilters.signature || "";
          el("tx-filter-min-sol").value = savedFilters.min_sol ?? "";
          el("tx-filter-max-sol").value = savedFilters.max_sol ?? "";
          if (savedFilters.time_from) {
            el("tx-filter-from").value = new Date(savedFilters.time_from)
              .toISOString()
              .slice(0, 16);
          }
          if (savedFilters.time_to) {
            el("tx-filter-to").value = new Date(savedFilters.time_to)
              .toISOString()
              .slice(0, 16);
          }
          State.filters = savedFilters;
        }

        const savedUi = AppState.load("tx.ui", null);
        const isAdvancedOpen = savedUi?.advancedOpen ?? false;
        setAdvancedPanel(isAdvancedOpen);
      }

      function setAdvancedPanel(expanded) {
        const panel = el("tx-advanced-filters");
        const toggle = el("tx-toggle-advanced");
        if (!panel || !toggle) return;
        const isExpanded = !!expanded;
        panel.dataset.expanded = isExpanded ? "true" : "false";
        toggle.setAttribute("aria-expanded", isExpanded ? "true" : "false");
        const icon = toggle.querySelector(".toggle-icon");
        if (icon) {
          icon.textContent = isExpanded ? "â–²" : "â–¼";
        }
      }

      function toggleAdvancedPanel() {
        const panel = el("tx-advanced-filters");
        if (!panel) return;
        const nextState = panel.dataset.expanded !== "true";
        setAdvancedPanel(nextState);
        AppState.save("tx.ui", { advancedOpen: nextState });
      }

      async function fetchList(filters, cursor, limit = 50) {
        const body = { filters, pagination: { cursor, limit } };
        const res = await fetch("/api/transactions/list", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error("List request failed");
        return res.json();
      }

      async function fetchSummary() {
        const res = await fetch("/api/transactions/summary", {
          method: "POST",
        });
        if (!res.ok) return null;
        return res.json();
      }

      function updateSummaryBar(summaryOverride) {
        const metaEl = el("tx-summary");
        if (!metaEl) return;
        if (summaryOverride !== undefined) {
          State.summary = summaryOverride;
          if (summaryOverride) {
            markLastUpdated();
          }
        }
        const summary = State.summary;
        const pieces = [];
        if (summary) {
          pieces.push(
            `Total: ${formatNumber(summary.total || 0, 0, "0")}`,
            `Success: ${formatNumber(summary.success_count || 0, 0, "0")}`,
            `Failed: ${formatNumber(summary.failed_count || 0, 0, "0")}`,
            `Success Rate: ${formatRate(summary.success_rate)}`
          );
        }
        pieces.push(`Loaded: ${formatNumber(State.items.length, 0, "0")}`);
        const baseText = pieces.join(" â€¢ ");
        metaEl.dataset.summaryText = baseText;
        updateFilterMeta();
        updateSummaryCards(summary);
      }

      function wireRowClicks() {
        document.querySelectorAll(".tx-link").forEach((a) => {
          a.addEventListener("click", async (e) => {
            e.preventDefault();
            const sig = a.getAttribute("data-signature");
            // For now, open solscan (could add modal later)
            window.open(`https://solscan.io/tx/${sig}`, "_blank");
          });
        });
      }

      function ensureScrollGuard() {
        const tbody = el("tx-tbody");
        if (!tbody) return;
        let guard = el("tx-scroll-guard");
        if (!guard) {
          guard = document.createElement("tr");
          guard.id = "tx-scroll-guard";
          guard.className = "scroll-guard-row";
          const cell = document.createElement("td");
          cell.colSpan = 11;
          cell.className = "scroll-guard-cell";
          guard.appendChild(cell);
        }

        if (guard.parentElement !== tbody) {
          if (guard.parentElement) {
            guard.parentElement.removeChild(guard);
          }
          tbody.appendChild(guard);
        } else if (tbody.lastElementChild !== guard) {
          tbody.appendChild(guard);
        }
      }

      function setScrollGuardState(state) {
        const cell = qs("#tx-scroll-guard .scroll-guard-cell");
        if (!cell) return;
        cell.classList.toggle("loading", state === "loading");
        if (state === "loading") {
          cell.textContent = "Loading more transactionsâ€¦";
        } else if (state === "end") {
          cell.textContent = State.items.length > 0 ? "No more results" : "";
          if (State.scrollObserver) {
            State.scrollObserver.disconnect();
            State.scrollObserver = null;
          }
        } else {
          cell.textContent = "";
        }
      }

      function setupScrollObserver() {
        if (State.scrollObserver) {
          State.scrollObserver.disconnect();
        }
        const guard = el("tx-scroll-guard");
        const container = document.querySelector(".table-wrap");
        if (!guard || !container) {
          State.scrollObserver = null;
          State.scrollContainer = null;
          return;
        }

        State.scrollContainer = container;
        if (!State.next_cursor) {
          State.scrollObserver = null;
          return;
        }

        State.scrollObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                loadMore();
              }
            });
          },
          { root: container, rootMargin: "320px 0px 0px 0px", threshold: 0 }
        );

        State.scrollObserver.observe(guard);
      }

      const State = {
        items: [],
        next_cursor: null,
        loading: false,
        filters: null,
        pendingReload: false,
        summary: null,
        scrollObserver: null,
        scrollContainer: null,
        lastUpdatedAt: null,
      };

      const Lifecycle = {
        statusIntervalId: null,
        cleanupRegistered: false,
      };

      async function loadInitial(options = {}) {
        const reuseState = options.reuseState ?? false;
        if (State.loading) {
          State.pendingReload = true;
          return;
        }
        State.loading = true;
        State.summary = null;
        updateSummaryCards(null);
        State.lastUpdatedAt = null;
        updateLastUpdatedLabel();
        clearLastUpdatedTicker();
        if (!reuseState || !State.filters) {
          State.filters = buildFilters();
          AppState.save("tx.filters", State.filters);
        }
        const tbody = el("tx-tbody");
        if (tbody) {
          tbody.innerHTML =
            '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-secondary)">Loading transactions...</td></tr>';
        }

        try {
          const data = await fetchList(State.filters, null, 50);
          State.items = data.items || [];
          State.next_cursor = data.next_cursor || null;

          if (tbody) {
            tbody.innerHTML = "";
            if (State.items.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-secondary)">No transactions found</td></tr>';
            } else {
              const fragment = document.createDocumentFragment();
              State.items.forEach((row) =>
                fragment.appendChild(renderRow(row))
              );
              tbody.appendChild(fragment);
            }
          }

          wireRowClicks();
          ensureScrollGuard();
          setScrollGuardState(State.next_cursor ? "idle" : "end");
          setupScrollObserver();
          markLastUpdated();
          updateSummaryBar();

          const summary = await fetchSummary();
          updateSummaryBar(summary);
        } catch (err) {
          console.error("Failed to load transactions", err);
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--badge-error)">Failed to load transactions</td></tr>';
          }
          State.items = [];
          State.next_cursor = null;
          ensureScrollGuard();
          setScrollGuardState("end");
          updateSummaryBar(null);
        } finally {
          State.loading = false;
          if (State.pendingReload) {
            State.pendingReload = false;
            setTimeout(() => loadInitial({ reuseState: true }), 0);
          }
        }
      }

      async function loadMore() {
        if (State.loading || !State.next_cursor) return;
        State.loading = true;
        ensureScrollGuard();
        setScrollGuardState("loading");
        try {
          const data = await fetchList(State.filters, State.next_cursor, 50);
          const tbody = el("tx-tbody");
          const rows = data.items || [];
          if (tbody && rows.length) {
            const fragment = document.createDocumentFragment();
            rows.forEach((row) => {
              State.items.push(row);
              fragment.appendChild(renderRow(row));
            });
            tbody.appendChild(fragment);
            wireRowClicks();
          } else {
            rows.forEach((row) => State.items.push(row));
          }

          State.next_cursor = data.next_cursor || null;
          ensureScrollGuard();
          setScrollGuardState(State.next_cursor ? "idle" : "end");
          markLastUpdated();
          updateSummaryBar();
        } catch (err) {
          console.error("Failed to load additional transactions", err);
          setScrollGuardState("end");
        } finally {
          State.loading = false;
          if (State.pendingReload) {
            State.pendingReload = false;
            setTimeout(() => loadInitial({ reuseState: true }), 0);
          }
        }
      }

      function applyFilters() {
        State.items = [];
        State.next_cursor = null;
        State.filters = buildFilters();
        AppState.save("tx.filters", State.filters);
        updateFilterMeta();
        loadInitial({ reuseState: true });
      }

      function resetFilters() {
        resetGroupToAll(qs('.filter-chip-group[data-filter-group="type"]'));
        resetGroupToAll(
          qs('.filter-chip-group[data-filter-group="direction"]')
        );
        resetGroupToAll(qs('.filter-chip-group[data-filter-group="status"]'));
        [
          "tx-filter-router",
          "tx-filter-mint",
          "tx-filter-signature",
          "tx-filter-min-sol",
          "tx-filter-max-sol",
        ].forEach((id) => (el(id).value = ""));
        el("tx-filter-from").value = "";
        el("tx-filter-to").value = "";
        AppState.save("tx.filters", null);
        AppState.save("tx.ui", { advancedOpen: false });
        setAdvancedPanel(false);
        applyFilters();
      }

      function onWsUnavailable() {
        // Fallback: ensure polling keeps the table updated
        if (!State.loading) {
          loadInitial({ reuseState: true });
        }
      }

      // Global init function for Router to call during SPA navigation
      window.initTransactionsPage = function () {
        console.log("[Transactions] Initializing page");
        registerLifecycleCleanup();
        updateLastUpdatedLabel();
        initChipGroups();
        applySavedFilters();
        updateFilterMeta();
        loadInitial({ reuseState: true });

        const applyBtn = document.getElementById("tx-apply-filters");
        const resetBtn = document.getElementById("tx-reset-filters");

        if (applyBtn && !applyBtn.__listenerAttached) {
          applyBtn.addEventListener("click", applyFilters);
          applyBtn.__listenerAttached = true;
        }
        if (resetBtn && !resetBtn.__listenerAttached) {
          resetBtn.addEventListener("click", resetFilters);
          resetBtn.__listenerAttached = true;
        }

        const toggleBtn = document.getElementById("tx-toggle-advanced");
        if (toggleBtn && !toggleBtn.__listenerAttached) {
          toggleBtn.addEventListener("click", toggleAdvancedPanel);
          toggleBtn.__listenerAttached = true;
        }

        const signatureClear = document.getElementById("tx-clear-signature");
        if (signatureClear && !signatureClear.__listenerAttached) {
          signatureClear.addEventListener("click", () => {
            el("tx-filter-signature").value = "";
            updateFilterMeta();
          });
          signatureClear.__listenerAttached = true;
        }

        [
          "tx-filter-router",
          "tx-filter-mint",
          "tx-filter-signature",
          "tx-filter-min-sol",
          "tx-filter-max-sol",
          "tx-filter-from",
          "tx-filter-to",
        ].forEach((id) => {
          const input = el(id);
          if (input && !input.__metaListenerAttached) {
            input.addEventListener("input", updateFilterMeta);
            input.__metaListenerAttached = true;
          }
        });
      };

      // Execute initialization immediately (works for both initial load and SPA navigation)
      initTransactionsPage();
    })();
  </script>
</div>
