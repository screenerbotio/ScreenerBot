<div class="page-table">
  <style>
    .transactions-toolbar {
      margin-bottom: 8px;
    }

    .transactions-toolbar .toolbar-actions {
      gap: 8px;
    }

    .transactions-toolbar .toolbar-row--filters {
      align-items: flex-end;
      gap: 10px;
    }

    .transactions-toolbar .toolbar-row--filters .toolbar-field--grow {
      min-width: 220px;
      flex: 1 1 220px;
    }

    .transactions-toolbar .toolbar-row--filters .toolbar-field--compact {
      min-width: 110px;
    }

    .transactions-toolbar .advanced-toggle {
      justify-content: flex-start;
    }

    .transactions-toolbar .advanced-panel {
      border-top: 1px dashed var(--border-color);
      padding-top: 8px;
    }

    .transactions-toolbar .advanced-panel[data-expanded="true"] {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .transactions-toolbar .advanced-panel[data-expanded="false"] {
      display: none;
    }

    .transactions-toolbar .date-range-inputs {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .transactions-toolbar .range-separator {
      color: var(--text-muted);
      font-size: 0.8em;
    }

    .transactions-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .transactions-summary-card {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-card);
    }

    .transactions-summary-card .summary-label {
      font-size: 0.7em;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 0;
    }

    .transactions-summary-card .summary-value {
      font-family: var(
        --font-mono,
        "SFMono-Regular",
        Menlo,
        Monaco,
        Consolas,
        "Liberation Mono",
        "Courier New",
        monospace
      );
      font-size: 0.95em;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .transactions-summary-card .summary-subvalue {
      color: var(--text-secondary);
      font-size: 0.75em;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      line-height: 1.4;
    }

    .transactions-summary-card .summary-subvalue code {
      font-size: 0.9em;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-secondary);
      background: var(--bg-primary);
    }

    .pill-status-confirmed,
    .pill-status-finalized {
      border-color: var(--badge-online);
      color: var(--badge-online);
    }

    .pill-status-pending {
      border-color: var(--badge-loading);
      color: var(--badge-loading);
    }

    .pill-status-failed {
      border-color: var(--badge-error);
      color: var(--badge-error);
    }

    .pill-direction-incoming {
      border-color: var(--badge-online);
      color: var(--badge-online);
    }

    .pill-direction-outgoing {
      border-color: var(--badge-error);
      color: var(--badge-error);
    }

    .pill-direction-internal {
      border-color: var(--text-secondary);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--badge-online);
      font-weight: 600;
    }

    .value-negative {
      color: var(--badge-error);
      font-weight: 600;
    }

    .scroll-guard-cell {
      color: var(--text-secondary);
      font-size: 0.9em;
      padding: 18px;
    }

    .scroll-guard-cell.loading {
      color: var(--text-muted);
    }
  </style>
  <div class="toolbar transactions-toolbar">
    <div class="toolbar-row toolbar-row--head">
      <div class="toolbar-title-block">
        <span class="toolbar-title">üí± Transactions</span>
        <span id="tx-summary" class="toolbar-meta"></span>
        <span id="tx-last-updated" class="toolbar-meta">Last update ‚Äî</span>
      </div>
      <div class="toolbar-actions">
        <button id="tx-apply-filters" class="btn btn-primary" type="button">
          Apply Filters
        </button>
        <button id="tx-reset-filters" class="btn" type="button">Reset</button>
      </div>
    </div>

    <div class="toolbar-row toolbar-row--filters">
      <div class="toolbar-field toolbar-field--grow">
        <label class="toolbar-label" for="tx-filter-signature">Signature</label>
        <div class="toolbar-search">
          <span class="toolbar-search__icon" aria-hidden="true">üîç</span>
          <input
            type="text"
            id="tx-filter-signature"
            class="toolbar-input"
            placeholder="Signature contains..."
            autocomplete="off"
          />
          <button
            class="toolbar-search__clear input-clear"
            type="button"
            id="tx-clear-signature"
            title="Clear signature filter"
            aria-label="Clear signature filter"
            hidden
          >
            ‚úï
          </button>
        </div>
      </div>
      <div class="toolbar-field toolbar-field--compact">
        <label class="toolbar-label" for="tx-filter-type">Type</label>
        <select id="tx-filter-type" class="toolbar-select">
          <option value="all">All types</option>
          <option value="buy">Buy</option>
          <option value="sell">Sell</option>
          <option value="swap">Swap</option>
          <option value="transfer">Transfer</option>
          <option value="ata">ATA</option>
          <option value="failed">Failed</option>
          <option value="unknown">Unknown</option>
        </select>
      </div>
      <div class="toolbar-field toolbar-field--compact">
        <label class="toolbar-label" for="tx-filter-direction">Direction</label>
        <select id="tx-filter-direction" class="toolbar-select">
          <option value="all">All directions</option>
          <option value="Incoming">Incoming</option>
          <option value="Outgoing">Outgoing</option>
          <option value="Internal">Internal</option>
          <option value="Unknown">Unknown</option>
        </select>
      </div>
      <div class="toolbar-field toolbar-field--compact">
        <label class="toolbar-label" for="tx-filter-status">Status</label>
        <select id="tx-filter-status" class="toolbar-select">
          <option value="all">All statuses</option>
          <option value="Pending">Pending</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Finalized">Finalized</option>
          <option value="Failed">Failed</option>
        </select>
      </div>
    </div>

    <div class="toolbar-row advanced-toggle">
      <button class="btn btn-ghost" type="button" id="tx-toggle-advanced">
        <span class="toggle-icon">‚ñº</span>
        Advanced filters
      </button>
    </div>

    <div
      class="toolbar-row advanced-panel"
      id="tx-advanced-filters"
      data-expanded="false"
    >
      <div class="toolbar-field toolbar-field--compact">
        <label class="toolbar-label" for="tx-filter-router">Router</label>
        <input
          type="text"
          id="tx-filter-router"
          class="toolbar-input"
          placeholder="Router (jupiter, raydium...)"
          autocomplete="off"
        />
      </div>
      <div class="toolbar-field toolbar-field--compact">
        <label class="toolbar-label" for="tx-filter-mint">Token Mint</label>
        <input
          type="text"
          id="tx-filter-mint"
          class="toolbar-input"
          placeholder="Token mint..."
          autocomplete="off"
        />
      </div>
      <div class="toolbar-field toolbar-field--compact date-range">
        <span class="toolbar-label">Time Range</span>
        <div class="date-range-inputs">
          <input
            type="datetime-local"
            id="tx-filter-from"
            class="toolbar-input"
          />
          <span class="range-separator">‚Üí</span>
          <input
            type="datetime-local"
            id="tx-filter-to"
            class="toolbar-input"
          />
        </div>
      </div>
      <div class="toolbar-field toolbar-field--compact">
        <label class="toolbar-label" for="tx-filter-min-sol">Min SOL Œî</label>
        <input
          type="number"
          step="0.0001"
          id="tx-filter-min-sol"
          class="toolbar-input"
          placeholder="Min SOL"
        />
      </div>
      <div class="toolbar-field toolbar-field--compact">
        <label class="toolbar-label" for="tx-filter-max-sol">Max SOL Œî</label>
        <input
          type="number"
          step="0.0001"
          id="tx-filter-max-sol"
          class="toolbar-input"
          placeholder="Max SOL"
        />
      </div>
    </div>
  </div>
  <div class="transactions-summary-grid" id="tx-summary-cards">
    <div class="transactions-summary-card">
      <div class="summary-label">Processed</div>
      <div class="summary-value" id="tx-stat-total">‚Äî</div>
      <div class="summary-subvalue">
        <span><span id="tx-stat-success">‚Äî</span> success</span>
        <span>‚Ä¢</span>
        <span><span id="tx-stat-failed">‚Äî</span> failed</span>
      </div>
      <div class="summary-subvalue" id="tx-stat-success-rate">
        Success ‚Äî ‚Ä¢ Fail ‚Äî
      </div>
    </div>
    <div class="transactions-summary-card">
      <div class="summary-label">Queues</div>
      <div class="summary-value" id="tx-stat-pending-global">‚Äî</div>
      <div class="summary-subvalue">
        <span>Local</span>
        <span id="tx-stat-pending-local">‚Äî</span>
      </div>
      <div class="summary-subvalue">
        <span>Deferred</span>
        <span id="tx-stat-deferred">‚Äî</span>
      </div>
    </div>
    <div class="transactions-summary-card">
      <div class="summary-label">Database</div>
      <div class="summary-value" id="tx-stat-db-size">‚Äî</div>
      <div class="summary-subvalue">
        <span>Schema</span>
        <span id="tx-stat-schema">‚Äî</span>
      </div>
      <div class="summary-subvalue">
        <span>Loaded</span>
        <span id="tx-stat-loaded">‚Äî</span>
      </div>
    </div>
    <div class="transactions-summary-card">
      <div class="summary-label">Known Signatures</div>
      <div class="summary-value" id="tx-stat-newest-sig">‚Äî</div>
      <div class="summary-subvalue">
        <span>Oldest</span>
        <span id="tx-stat-oldest-sig">‚Äî</span>
      </div>
      <div class="summary-subvalue">
        <span id="tx-stat-bootstrap-status">Bootstrap ‚Äî</span>
        <span id="tx-stat-bootstrap-cursor"></span>
      </div>
    </div>
  </div>
  <div class="table-wrap">
    <table class="table" id="tx-table">
      <thead>
        <tr>
          <th style="min-width: 150px">Date / Time</th>
          <th style="min-width: 140px">Signature</th>
          <th style="min-width: 80px">Type</th>
          <th style="min-width: 80px">Direction</th>
          <th style="min-width: 80px">Status</th>
          <th style="min-width: 120px">Mint</th>
          <th style="min-width: 100px">Router</th>
          <th style="min-width: 100px">SOL Œî</th>
          <th style="min-width: 90px">Fee</th>
          <th style="min-width: 90px">ATA Rent</th>
          <th style="min-width: 60px">Instr</th>
        </tr>
      </thead>
      <tbody id="tx-tbody">
        <tr>
          <td colspan="11" style="text-align: center; padding: 40px">
            Loading transactions...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <script>
    (function () {
      function toRfc3339Local(dtInput) {
        if (!dtInput || !dtInput.value) return null;
        try {
          const d = new Date(dtInput.value);
          return d.toISOString();
        } catch (_) {
          return null;
        }
      }

      function el(id) {
        return document.getElementById(id);
      }

      function qs(selector, scope = document) {
        return scope.querySelector(selector);
      }

      function qsa(selector, scope = document) {
        return Array.from(scope.querySelectorAll(selector));
      }

      function textFromInput(id) {
        const input = el(id);
        if (!input) return null;
        const value = input.value.trim();
        return value ? value : null;
      }

      function numberFromInput(id) {
        const input = el(id);
        if (!input) return null;
        const raw = input.value.trim();
        if (raw === "") return null;
        const parsed = parseFloat(raw);
        return Number.isFinite(parsed) ? parsed : null;
      }

      const dateTimeFormatter = new Intl.DateTimeFormat(undefined, {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });

      function escapeHtml(value) {
        if (value === null || value === undefined) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function toSlug(value) {
        if (!value) return "";
        return String(value)
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
      }

      // Use Utils.formatSignatureCompact, Utils.formatNumber, Utils.formatPercent, Utils.formatSol

      function renderPill(label, prefix) {
        if (!label || label === "‚Äî") return "‚Äî";
        const slug = toSlug(label);
        const className = slug ? `${prefix}-${slug}` : "";
        return `<span class="pill ${className}">${escapeHtml(label)}</span>`;
      }

      // Use Utils.formatTimeAgo and Utils.formatTimestamp

      function updateLastUpdatedLabel() {
        const label = el("tx-last-updated");
        if (!label) return;
        if (!State.lastUpdatedAt) {
          label.textContent = "Last update ‚Äî";
          label.title = "";
          return;
        }
        const date = new Date(State.lastUpdatedAt);
        const relative = formatRelativeTime(date) || "just now";
        label.textContent = `Last update ${relative}`;
        label.title = formatTimestampDisplay(date);
      }

      function ensureLastUpdatedTicker() {
        if (Lifecycle.statusIntervalId) return;
        const intervalId = setInterval(updateLastUpdatedLabel, 30_000);
        Lifecycle.statusIntervalId = intervalId;
        if (window.Router && typeof Router.trackInterval === "function") {
          Router.trackInterval(intervalId);
        }
      }

      function clearLastUpdatedTicker() {
        if (!Lifecycle.statusIntervalId) return;
        clearInterval(Lifecycle.statusIntervalId);
        Lifecycle.statusIntervalId = null;
      }

      function markLastUpdated() {
        State.lastUpdatedAt = Date.now();
        updateLastUpdatedLabel();
        ensureLastUpdatedTicker();
      }

      function updateSummaryCards(summary) {
        const totalEl = el("tx-stat-total");
        if (!totalEl) return;

        if (!summary) {
          totalEl.textContent = "‚Äî";
          const successEl = el("tx-stat-success");
          const failedEl = el("tx-stat-failed");
          const rateEl = el("tx-stat-success-rate");
          const pendingGlobalEl = el("tx-stat-pending-global");
          const pendingLocalEl = el("tx-stat-pending-local");
          const deferredEl = el("tx-stat-deferred");
          const sizeEl = el("tx-stat-db-size");
          const schemaEl = el("tx-stat-schema");
          const loadedEl = el("tx-stat-loaded");
          const newestEl = el("tx-stat-newest-sig");
          const oldestEl = el("tx-stat-oldest-sig");
          const bootstrapStatusEl = el("tx-stat-bootstrap-status");
          const bootstrapCursorEl = el("tx-stat-bootstrap-cursor");
          if (successEl) successEl.textContent = "‚Äî";
          if (failedEl) failedEl.textContent = "‚Äî";
          if (rateEl) rateEl.textContent = "Success ‚Äî ‚Ä¢ Fail ‚Äî";
          if (pendingGlobalEl) pendingGlobalEl.textContent = "‚Äî";
          if (pendingLocalEl) pendingLocalEl.textContent = "‚Äî";
          if (deferredEl) deferredEl.textContent = "‚Äî";
          if (sizeEl) sizeEl.textContent = "‚Äî";
          if (schemaEl) schemaEl.textContent = "‚Äî";
          if (loadedEl)
            loadedEl.textContent = formatNumber(State.items.length, 0, "0");
          if (newestEl) newestEl.innerHTML = "‚Äî";
          if (oldestEl) oldestEl.innerHTML = "‚Äî";
          if (bootstrapStatusEl) bootstrapStatusEl.textContent = "Bootstrap ‚Äî";
          if (bootstrapCursorEl) bootstrapCursorEl.innerHTML = "";
          return;
        }

        const successEl = el("tx-stat-success");
        const failedEl = el("tx-stat-failed");
        const rateEl = el("tx-stat-success-rate");
        const pendingGlobalEl = el("tx-stat-pending-global");
        const pendingLocalEl = el("tx-stat-pending-local");
        const deferredEl = el("tx-stat-deferred");
        const sizeEl = el("tx-stat-db-size");
        const schemaEl = el("tx-stat-schema");
        const loadedEl = el("tx-stat-loaded");
        const newestEl = el("tx-stat-newest-sig");
        const oldestEl = el("tx-stat-oldest-sig");
        const bootstrapStatusEl = el("tx-stat-bootstrap-status");
        const bootstrapCursorEl = el("tx-stat-bootstrap-cursor");

        totalEl.textContent = formatNumber(summary.total || 0, 0, "0");
        if (successEl) {
          successEl.textContent = formatNumber(
            summary.success_count || 0,
            0,
            "0"
          );
        }
        if (failedEl) {
          failedEl.textContent = formatNumber(
            summary.failed_count || 0,
            0,
            "0"
          );
        }
        if (rateEl) {
          rateEl.textContent = `Success ${formatRate(
            summary.success_rate
          )} ‚Ä¢ Fail ${formatRate(summary.failure_rate)}`;
        }
        if (pendingGlobalEl) {
          pendingGlobalEl.textContent = formatNumber(
            summary.pending_global || 0,
            0,
            "0"
          );
        }
        if (pendingLocalEl) {
          pendingLocalEl.textContent = formatNumber(
            summary.pending_local || 0,
            0,
            "0"
          );
        }
        if (deferredEl) {
          deferredEl.textContent = formatNumber(
            summary.deferred_count || 0,
            0,
            "0"
          );
        }
        if (sizeEl) {
          sizeEl.textContent = `${formatNumber(
            summary.db_size_mb || 0,
            2,
            "0.00"
          )} MB`;
        }
        if (schemaEl) {
          schemaEl.textContent = summary.db_schema_version
            ? `v${summary.db_schema_version}`
            : "‚Äî";
        }
        if (loadedEl) {
          loadedEl.textContent = formatNumber(State.items.length, 0, "0");
        }
        if (newestEl) {
          if (summary.newest_known_signature) {
            const sig = summary.newest_known_signature;
            newestEl.innerHTML = `<code title="${escapeHtml(sig)}">${escapeHtml(
              formatSignatureCompact(sig, { start: 6, end: 6 })
            )}</code>`;
          } else {
            newestEl.innerHTML = "‚Äî";
          }
        }
        if (oldestEl) {
          if (summary.oldest_known_signature) {
            const sig = summary.oldest_known_signature;
            oldestEl.innerHTML = `<code title="${escapeHtml(sig)}">${escapeHtml(
              formatSignatureCompact(sig, { start: 6, end: 6 })
            )}</code>`;
          } else {
            oldestEl.innerHTML = "‚Äî";
          }
        }
        if (bootstrapStatusEl) {
          bootstrapStatusEl.textContent = summary.bootstrap_state
            ?.full_history_completed
            ? "Bootstrap Completed"
            : "Bootstrap In Progress";
        }
        if (bootstrapCursorEl) {
          const cursor = summary.bootstrap_state?.backfill_cursor;
          if (cursor) {
            bootstrapCursorEl.innerHTML = `<code title="${escapeHtml(
              cursor
            )}">${escapeHtml(
              formatSignatureCompact(cursor, { start: 6, end: 6 })
            )}</code>`;
          } else {
            bootstrapCursorEl.innerHTML = "";
          }
        }
      }

      function registerLifecycleCleanup() {
        if (
          !window.Router ||
          typeof Router.registerCleanup !== "function" ||
          Lifecycle.cleanupRegistered
        ) {
          return;
        }
        Router.registerCleanup(() => {
          teardownTransactionsPage();
        });
        Lifecycle.cleanupRegistered = true;
      }

      function teardownTransactionsPage() {
        clearLastUpdatedTicker();
        State.lastUpdatedAt = null;
        updateLastUpdatedLabel();
        if (State.scrollObserver) {
          State.scrollObserver.disconnect();
          State.scrollObserver = null;
        }
        State.scrollContainer = null;
        Lifecycle.cleanupRegistered = false;
      }

      function renderRow(row) {
        const tr = document.createElement("tr");
        const timestamp = new Date(row.timestamp);
        const dateTime = dateTimeFormatter.format(timestamp);
        const signature = row.signature || "";
        const signatureDisplay = signature
          ? formatSignatureCompact(signature, { start: 8, end: 6 })
          : "‚Äî";
        const type = row.type || row.transaction_type || "‚Äî";
        const dir = row.direction || "‚Äî";
        const status = row.status || "‚Äî";
        const mintFull = row.token_mint || "";
        const mintDisplay = mintFull
          ? formatSignatureCompact(mintFull, { start: 4, end: 5 })
          : "‚Äî";
        const router = row.router || "‚Äî";
        const solDelta = Number(row.sol_delta ?? 0);
        const fee = Number(row.fee_sol ?? 0);
        const ata = Number(row.ata_rents ?? 0);
        const instr = Number.isFinite(row.instructions_count)
          ? row.instructions_count
          : 0;
        const solClass =
          solDelta > 0
            ? "monospace value-positive"
            : solDelta < 0
            ? "monospace value-negative"
            : "monospace";

        tr.innerHTML = `
          <td title="${escapeHtml(timestamp.toLocaleString())}">${escapeHtml(
          dateTime
        )}</td>
          <td>
            ${
              signature
                ? `<a href="#" data-signature="${escapeHtml(
                    signature
                  )}" class="tx-link" title="${escapeHtml(
                    signature
                  )}">${escapeHtml(signatureDisplay)}</a>`
                : "‚Äî"
            }
          </td>
          <td>${
            type && type !== "‚Äî"
              ? `<span class="pill">${escapeHtml(type)}</span>`
              : "‚Äî"
          }</td>
          <td>${
            dir && dir !== "‚Äî" ? renderPill(dir, "pill-direction") : "‚Äî"
          }</td>
          <td>${
            status && status !== "‚Äî" ? renderPill(status, "pill-status") : "‚Äî"
          }</td>
          <td title="${escapeHtml(mintFull)}">
            ${mintFull ? `<code>${escapeHtml(mintDisplay)}</code>` : "‚Äî"}
          </td>
          <td>${router && router !== "‚Äî" ? escapeHtml(router) : "‚Äî"}</td>
          <td class="${solClass}">${escapeHtml(formatSol(solDelta))}</td>
          <td class="monospace">${escapeHtml(
            formatNumber(fee, 6, "0.000000")
          )}</td>
          <td class="monospace">${escapeHtml(
            formatNumber(ata, 6, "0.000000")
          )}</td>
          <td>${escapeHtml(String(instr))}</td>
        `;
        return tr;
      }

      function getTypeFilterValues() {
        const select = el("tx-filter-type");
        if (!select) return [];
        const value = select.value || "all";
        return value === "all" ? [] : [value];
      }

      function setTypeFilterValues(values) {
        const select = el("tx-filter-type");
        if (!select) return;
        const candidate =
          Array.isArray(values) && values.length > 0 ? values[0] : "all";
        const hasOption = Array.from(select.options).some(
          (opt) => opt.value === candidate
        );
        select.value = hasOption ? candidate : "all";
      }

      function getSelectValue(id) {
        const select = el(id);
        if (!select) return null;
        const value = select.value || "all";
        return value === "all" ? null : value;
      }

      function setSelectValue(id, value) {
        const select = el(id);
        if (!select) return;
        const normalized = value ?? "all";
        const hasOption = Array.from(select.options).some(
          (opt) => opt.value === normalized
        );
        select.value = hasOption ? normalized : "all";
      }

      function initFilterDropdowns() {
        ["tx-filter-type", "tx-filter-direction", "tx-filter-status"].forEach(
          (id) => {
            const select = el(id);
            if (select && !select.__listenerAttached) {
              select.addEventListener("change", updateFilterMeta);
              select.__listenerAttached = true;
            }
          }
        );
      }

      function buildFilters() {
        const selectedTypes = getTypeFilterValues();
        const direction = getSelectValue("tx-filter-direction");
        const status = getSelectValue("tx-filter-status");
        const router = textFromInput("tx-filter-router");
        const mint = textFromInput("tx-filter-mint");
        const signature = textFromInput("tx-filter-signature");
        const min_sol = numberFromInput("tx-filter-min-sol");
        const max_sol = numberFromInput("tx-filter-max-sol");
        const time_from = toRfc3339Local(el("tx-filter-from"));
        const time_to = toRfc3339Local(el("tx-filter-to"));
        return {
          types: selectedTypes,
          direction,
          status,
          signature,
          router,
          mint,
          min_sol,
          max_sol,
          time_from,
          time_to,
        };
      }

      function countActiveFilters(filters) {
        if (!filters) return 0;
        let count = 0;
        if (filters.types && filters.types.length) count += 1;
        if (filters.direction) count += 1;
        if (filters.status) count += 1;
        if (filters.signature) count += 1;
        if (filters.router) count += 1;
        if (filters.mint) count += 1;
        const hasMin =
          filters.min_sol !== null && filters.min_sol !== undefined;
        const hasMax =
          filters.max_sol !== null && filters.max_sol !== undefined;
        if (hasMin || hasMax) count += 1;
        if (filters.time_from || filters.time_to) count += 1;
        return count;
      }

      function updateFilterMeta() {
        const current = buildFilters();
        const count = countActiveFilters(current);
        const metaEl = el("tx-summary");
        if (!metaEl) return;
        const summaryText = metaEl.dataset.summaryText || "";
        let finalText = summaryText;
        if (count > 0) {
          const filtersLabel = `${count} filter${
            count === 1 ? "" : "s"
          } active`;
          finalText = summaryText
            ? `${summaryText} ‚Ä¢ ${filtersLabel}`
            : filtersLabel;
        }
        metaEl.textContent = finalText || summaryText;
      }

      function applySavedFilters() {
        const savedFilters = AppState.load("tx.filters", null);
        if (savedFilters) {
          setTypeFilterValues(savedFilters.types || []);
          setSelectValue("tx-filter-direction", savedFilters.direction);
          setSelectValue("tx-filter-status", savedFilters.status);
          el("tx-filter-router").value = savedFilters.router || "";
          el("tx-filter-mint").value = savedFilters.mint || "";
          el("tx-filter-signature").value = savedFilters.signature || "";
          el("tx-filter-min-sol").value = savedFilters.min_sol ?? "";
          el("tx-filter-max-sol").value = savedFilters.max_sol ?? "";
          if (savedFilters.time_from) {
            el("tx-filter-from").value = new Date(savedFilters.time_from)
              .toISOString()
              .slice(0, 16);
          }
          if (savedFilters.time_to) {
            el("tx-filter-to").value = new Date(savedFilters.time_to)
              .toISOString()
              .slice(0, 16);
          }
          State.filters = savedFilters;
        }

        const savedUi = AppState.load("tx.ui", null);
        const isAdvancedOpen = savedUi?.advancedOpen ?? false;
        setAdvancedPanel(isAdvancedOpen);
      }

      function setAdvancedPanel(expanded) {
        const panel = el("tx-advanced-filters");
        const toggle = el("tx-toggle-advanced");
        if (!panel || !toggle) return;
        const isExpanded = !!expanded;
        panel.dataset.expanded = isExpanded ? "true" : "false";
        toggle.setAttribute("aria-expanded", isExpanded ? "true" : "false");
        const icon = toggle.querySelector(".toggle-icon");
        if (icon) {
          icon.textContent = isExpanded ? "‚ñ≤" : "‚ñº";
        }
      }

      function toggleAdvancedPanel() {
        const panel = el("tx-advanced-filters");
        if (!panel) return;
        const nextState = panel.dataset.expanded !== "true";
        setAdvancedPanel(nextState);
        AppState.save("tx.ui", { advancedOpen: nextState });
      }

      async function fetchList(filters, cursor, limit = 50) {
        const body = { filters, pagination: { cursor, limit } };
        const res = await fetch("/api/transactions/list", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error("List request failed");
        return res.json();
      }

      async function fetchSummary() {
        const res = await fetch("/api/transactions/summary", {
          method: "POST",
        });
        if (!res.ok) return null;
        return res.json();
      }

      function updateSummaryBar(summaryOverride) {
        const metaEl = el("tx-summary");
        if (!metaEl) return;
        if (summaryOverride !== undefined) {
          State.summary = summaryOverride;
          if (summaryOverride) {
            markLastUpdated();
          }
        }
        const summary = State.summary;
        const pieces = [];
        if (summary) {
          pieces.push(
            `Total: ${formatNumber(summary.total || 0, 0, "0")}`,
            `Success: ${formatNumber(summary.success_count || 0, 0, "0")}`,
            `Failed: ${formatNumber(summary.failed_count || 0, 0, "0")}`,
            `Success Rate: ${formatRate(summary.success_rate)}`
          );
        }
        pieces.push(`Loaded: ${formatNumber(State.items.length, 0, "0")}`);
        const baseText = pieces.join(" ‚Ä¢ ");
        metaEl.dataset.summaryText = baseText;
        updateFilterMeta();
        updateSummaryCards(summary);
      }

      function wireRowClicks() {
        document.querySelectorAll(".tx-link").forEach((a) => {
          a.addEventListener("click", async (e) => {
            e.preventDefault();
            const sig = a.getAttribute("data-signature");
            // For now, open solscan (could add modal later)
            window.open(`https://solscan.io/tx/${sig}`, "_blank");
          });
        });
      }

      function ensureScrollGuard() {
        const tbody = el("tx-tbody");
        if (!tbody) return;
        let guard = el("tx-scroll-guard");
        if (!guard) {
          guard = document.createElement("tr");
          guard.id = "tx-scroll-guard";
          guard.className = "scroll-guard-row";
          const cell = document.createElement("td");
          cell.colSpan = 11;
          cell.className = "scroll-guard-cell";
          guard.appendChild(cell);
        }

        if (guard.parentElement !== tbody) {
          if (guard.parentElement) {
            guard.parentElement.removeChild(guard);
          }
          tbody.appendChild(guard);
        } else if (tbody.lastElementChild !== guard) {
          tbody.appendChild(guard);
        }
      }

      function setScrollGuardState(state) {
        const cell = qs("#tx-scroll-guard .scroll-guard-cell");
        if (!cell) return;
        cell.classList.toggle("loading", state === "loading");
        if (state === "loading") {
          cell.textContent = "Loading more transactions‚Ä¶";
        } else if (state === "end") {
          cell.textContent = State.items.length > 0 ? "No more results" : "";
          if (State.scrollObserver) {
            State.scrollObserver.disconnect();
            State.scrollObserver = null;
          }
        } else {
          cell.textContent = "";
        }
      }

      function setupScrollObserver() {
        if (State.scrollObserver) {
          State.scrollObserver.disconnect();
        }
        const guard = el("tx-scroll-guard");
        const container = document.querySelector(".table-wrap");
        if (!guard || !container) {
          State.scrollObserver = null;
          State.scrollContainer = null;
          return;
        }

        State.scrollContainer = container;
        if (!State.next_cursor) {
          State.scrollObserver = null;
          return;
        }

        State.scrollObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                loadMore();
              }
            });
          },
          { root: container, rootMargin: "320px 0px 0px 0px", threshold: 0 }
        );

        State.scrollObserver.observe(guard);
      }

      const State = {
        items: [],
        next_cursor: null,
        loading: false,
        filters: null,
        pendingReload: false,
        summary: null,
        scrollObserver: null,
        scrollContainer: null,
        lastUpdatedAt: null,
      };

      const Lifecycle = {
        statusIntervalId: null,
        cleanupRegistered: false,
      };

      async function loadInitial(options = {}) {
        const reuseState = options.reuseState ?? false;
        if (State.loading) {
          State.pendingReload = true;
          return;
        }
        State.loading = true;
        State.summary = null;
        updateSummaryCards(null);
        State.lastUpdatedAt = null;
        updateLastUpdatedLabel();
        clearLastUpdatedTicker();
        if (!reuseState || !State.filters) {
          State.filters = buildFilters();
          AppState.save("tx.filters", State.filters);
        }
        const tbody = el("tx-tbody");
        if (tbody) {
          tbody.innerHTML =
            '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-secondary)">Loading transactions...</td></tr>';
        }

        try {
          const data = await fetchList(State.filters, null, 50);
          State.items = data.items || [];
          State.next_cursor = data.next_cursor || null;

          if (tbody) {
            tbody.innerHTML = "";
            if (State.items.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-secondary)">No transactions found</td></tr>';
            } else {
              const fragment = document.createDocumentFragment();
              State.items.forEach((row) =>
                fragment.appendChild(renderRow(row))
              );
              tbody.appendChild(fragment);
            }
          }

          wireRowClicks();
          ensureScrollGuard();
          setScrollGuardState(State.next_cursor ? "idle" : "end");
          setupScrollObserver();
          markLastUpdated();
          updateSummaryBar();

          const summary = await fetchSummary();
          updateSummaryBar(summary);
        } catch (err) {
          console.error("Failed to load transactions", err);
          if (tbody) {
            tbody.innerHTML =
              '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--badge-error)">Failed to load transactions</td></tr>';
          }
          State.items = [];
          State.next_cursor = null;
          ensureScrollGuard();
          setScrollGuardState("end");
          updateSummaryBar(null);
        } finally {
          State.loading = false;
          if (State.pendingReload) {
            State.pendingReload = false;
            setTimeout(() => loadInitial({ reuseState: true }), 0);
          }
        }
      }

      async function loadMore() {
        if (State.loading || !State.next_cursor) return;
        State.loading = true;
        ensureScrollGuard();
        setScrollGuardState("loading");
        try {
          const data = await fetchList(State.filters, State.next_cursor, 50);
          const tbody = el("tx-tbody");
          const rows = data.items || [];
          if (tbody && rows.length) {
            const fragment = document.createDocumentFragment();
            rows.forEach((row) => {
              State.items.push(row);
              fragment.appendChild(renderRow(row));
            });
            tbody.appendChild(fragment);
            wireRowClicks();
          } else {
            rows.forEach((row) => State.items.push(row));
          }

          State.next_cursor = data.next_cursor || null;
          ensureScrollGuard();
          setScrollGuardState(State.next_cursor ? "idle" : "end");
          markLastUpdated();
          updateSummaryBar();
        } catch (err) {
          console.error("Failed to load additional transactions", err);
          setScrollGuardState("end");
        } finally {
          State.loading = false;
          if (State.pendingReload) {
            State.pendingReload = false;
            setTimeout(() => loadInitial({ reuseState: true }), 0);
          }
        }
      }

      function applyFilters() {
        State.items = [];
        State.next_cursor = null;
        State.filters = buildFilters();
        AppState.save("tx.filters", State.filters);
        updateFilterMeta();
        loadInitial({ reuseState: true });
      }

      function resetFilters() {
        setTypeFilterValues([]);
        setSelectValue("tx-filter-direction", null);
        setSelectValue("tx-filter-status", null);
        [
          "tx-filter-router",
          "tx-filter-mint",
          "tx-filter-signature",
          "tx-filter-min-sol",
          "tx-filter-max-sol",
        ].forEach((id) => (el(id).value = ""));
        el("tx-filter-from").value = "";
        el("tx-filter-to").value = "";
        AppState.save("tx.filters", null);
        AppState.save("tx.ui", { advancedOpen: false });
        const signatureClearBtn = document.getElementById("tx-clear-signature");
        if (signatureClearBtn) {
          signatureClearBtn.setAttribute("hidden", "true");
        }
        setAdvancedPanel(false);
        applyFilters();
      }

      function onWsUnavailable() {
        // Fallback: ensure polling keeps the table updated
        if (!State.loading) {
          loadInitial({ reuseState: true });
        }
      }

      // Global init function for Router to call during SPA navigation
      window.initTransactionsPage = function () {
        console.log("[Transactions] Initializing page");
        registerLifecycleCleanup();
        updateLastUpdatedLabel();
        initFilterDropdowns();
        applySavedFilters();
        updateFilterMeta();
        loadInitial({ reuseState: true });

        const applyBtn = document.getElementById("tx-apply-filters");
        const resetBtn = document.getElementById("tx-reset-filters");

        if (applyBtn && !applyBtn.__listenerAttached) {
          applyBtn.addEventListener("click", applyFilters);
          applyBtn.__listenerAttached = true;
        }
        if (resetBtn && !resetBtn.__listenerAttached) {
          resetBtn.addEventListener("click", resetFilters);
          resetBtn.__listenerAttached = true;
        }

        const toggleBtn = document.getElementById("tx-toggle-advanced");
        if (toggleBtn && !toggleBtn.__listenerAttached) {
          toggleBtn.addEventListener("click", toggleAdvancedPanel);
          toggleBtn.__listenerAttached = true;
        }

        const signatureInput = el("tx-filter-signature");
        const signatureClear = document.getElementById("tx-clear-signature");
        const updateSignatureClear = () => {
          if (!signatureClear || !signatureInput) return;
          if (signatureInput.value.trim().length > 0) {
            signatureClear.removeAttribute("hidden");
          } else {
            signatureClear.setAttribute("hidden", "true");
          }
        };

        if (signatureInput && !signatureInput.__metaListenerAttached) {
          signatureInput.addEventListener("input", () => {
            updateSignatureClear();
            updateFilterMeta();
          });
          signatureInput.__metaListenerAttached = true;
        }

        if (signatureClear && !signatureClear.__listenerAttached) {
          signatureClear.addEventListener("click", () => {
            if (!signatureInput) return;
            if (signatureInput.value === "") return;
            signatureInput.value = "";
            updateSignatureClear();
            updateFilterMeta();
            signatureInput.focus();
          });
          signatureClear.__listenerAttached = true;
        }

        updateSignatureClear();

        [
          "tx-filter-router",
          "tx-filter-mint",
          "tx-filter-min-sol",
          "tx-filter-max-sol",
          "tx-filter-from",
          "tx-filter-to",
        ].forEach((id) => {
          const input = el(id);
          if (input && !input.__metaListenerAttached) {
            input.addEventListener("input", updateFilterMeta);
            input.__metaListenerAttached = true;
          }
        });
      };

      // Execute initialization immediately (works for both initial load and SPA navigation)
      window.initTransactionsPage();
    })();
  </script>
</div>
