<div class="page-table">
  <div class="toolbar">
    <span style="font-weight: 600">ðŸ’± Transactions</span>
    <select
      id="tx-filter-type"
      multiple
      size="1"
      style="
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-width: 100px;
      "
      title="Hold Ctrl/Cmd to select multiple types"
    >
      <option value="buy">Buy</option>
      <option value="sell">Sell</option>
      <option value="swap">Swap</option>
      <option value="transfer">Transfer</option>
      <option value="ata">ATA</option>
      <option value="failed">Failed</option>
      <option value="unknown">Unknown</option>
    </select>
    <select
      id="tx-filter-direction"
      style="
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
      "
    >
      <option value="">All Directions</option>
      <option value="Incoming">Incoming</option>
      <option value="Outgoing">Outgoing</option>
      <option value="Internal">Internal</option>
      <option value="Unknown">Unknown</option>
    </select>
    <select
      id="tx-filter-status"
      style="
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
      "
    >
      <option value="">All Status</option>
      <option value="Pending">Pending</option>
      <option value="Confirmed">Confirmed</option>
      <option value="Finalized">Finalized</option>
      <option value="Failed">Failed</option>
    </select>
    <input
      type="text"
      id="tx-filter-router"
      placeholder="Router (jupiter, raydium...)"
      style="
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-width: 140px;
      "
    />
    <input
      type="text"
      id="tx-filter-mint"
      placeholder="Token mint..."
      style="
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-width: 140px;
      "
    />
    <input
      type="datetime-local"
      id="tx-filter-from"
      style="
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
      "
    />
    <span style="color: var(--text-secondary)">â†’</span>
    <input
      type="datetime-local"
      id="tx-filter-to"
      style="
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
      "
    />
    <input
      type="number"
      step="0.0001"
      id="tx-filter-min-sol"
      placeholder="Min SOL"
      style="
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        width: 90px;
      "
    />
    <input
      type="number"
      step="0.0001"
      id="tx-filter-max-sol"
      placeholder="Max SOL"
      style="
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        width: 90px;
      "
    />
    <button id="tx-apply-filters" class="btn btn-primary">Apply</button>
    <button id="tx-reset-filters" class="btn">Reset</button>
    <div class="spacer"></div>
    <span
      id="tx-summary"
      style="color: var(--text-secondary); font-size: 0.9em"
    ></span>
  </div>
  <div class="table-wrap">
    <table class="table" id="tx-table">
      <thead>
        <tr>
          <th style="min-width: 90px">Time</th>
          <th style="min-width: 140px">Signature</th>
          <th style="min-width: 80px">Type</th>
          <th style="min-width: 80px">Direction</th>
          <th style="min-width: 80px">Status</th>
          <th style="min-width: 120px">Mint</th>
          <th style="min-width: 100px">Router</th>
          <th style="min-width: 100px">SOL Î”</th>
          <th style="min-width: 90px">Fee</th>
          <th style="min-width: 90px">ATA Rent</th>
          <th style="min-width: 60px">Instr</th>
        </tr>
      </thead>
      <tbody id="tx-tbody">
        <tr>
          <td colspan="11" style="text-align: center; padding: 40px">
            Loading transactions...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="footer-bar toolbar">
    <button class="btn" id="tx-load-more">Load more</button>
    <div class="spacer"></div>
    <span
      id="tx-items-count"
      style="color: var(--text-secondary); font-size: 0.9em"
    ></span>
  </div>

  <script>
    (function () {
      function toRfc3339Local(dtInput) {
        if (!dtInput || !dtInput.value) return null;
        try {
          const d = new Date(dtInput.value);
          return d.toISOString();
        } catch (_) {
          return null;
        }
      }

      function el(id) {
        return document.getElementById(id);
      }

      function renderRow(row) {
        const tr = document.createElement("tr");
        const time = new Date(row.timestamp).toLocaleTimeString();
        const sigShort =
          row.signature.slice(0, 8) + "â€¦" + row.signature.slice(-6);
        const type = row.type || row.transaction_type || "â€”";
        const dir = row.direction || "â€”";
        const status = row.status || "â€”";
        const mint = row.token_mint ? row.token_mint.slice(0, 8) + "â€¦" : "â€”";
        const router = row.router || "â€”";
        const sol = (row.sol_delta ?? 0).toFixed(6);
        const fee = (row.fee_sol ?? 0).toFixed(6);
        const ata = (row.ata_rents ?? 0).toFixed(6);
        const instr = row.instructions_count ?? 0;
        tr.innerHTML = `
          <td title="${new Date(row.timestamp).toLocaleString()}">${time}</td>
          <td><a href="#" data-signature="${
            row.signature
          }" class="tx-link">${sigShort}</a></td>
          <td>${type}</td>
          <td>${dir}</td>
          <td>${status}</td>
          <td title="${row.token_mint || ""}">${mint}</td>
          <td>${router}</td>
          <td class="monospace">${sol}</td>
          <td class="monospace">${fee}</td>
          <td class="monospace">${ata}</td>
          <td>${instr}</td>
        `;
        return tr;
      }

      function buildFilters() {
        const selectedTypes = Array.from(
          el("tx-filter-type").selectedOptions
        ).map((o) => o.value);
        const direction = el("tx-filter-direction").value || null;
        const status = el("tx-filter-status").value || null;
        const router = el("tx-filter-router").value.trim() || null;
        const mint = el("tx-filter-mint").value.trim() || null;
        const min_sol = el("tx-filter-min-sol").value
          ? parseFloat(el("tx-filter-min-sol").value)
          : null;
        const max_sol = el("tx-filter-max-sol").value
          ? parseFloat(el("tx-filter-max-sol").value)
          : null;
        const time_from = toRfc3339Local(el("tx-filter-from"));
        const time_to = toRfc3339Local(el("tx-filter-to"));
        return {
          types: selectedTypes,
          direction,
          status,
          router,
          mint,
          min_sol,
          max_sol,
          time_from,
          time_to,
        };
      }

      function applySavedFilters() {
        const saved = AppState.load("tx.filters", null);
        if (!saved) return;
        const typeSel = el("tx-filter-type");
        Array.from(typeSel.options).forEach((opt) => {
          opt.selected = (saved.types || []).includes(opt.value);
        });
        el("tx-filter-direction").value = saved.direction || "";
        el("tx-filter-status").value = saved.status || "";
        el("tx-filter-router").value = saved.router || "";
        el("tx-filter-mint").value = saved.mint || "";
        el("tx-filter-min-sol").value = saved.min_sol ?? "";
        el("tx-filter-max-sol").value = saved.max_sol ?? "";
        if (saved.time_from)
          el("tx-filter-from").value = new Date(saved.time_from)
            .toISOString()
            .slice(0, 16);
        if (saved.time_to)
          el("tx-filter-to").value = new Date(saved.time_to)
            .toISOString()
            .slice(0, 16);
      }

      async function fetchList(filters, cursor, limit = 50) {
        const body = { filters, pagination: { cursor, limit } };
        const res = await fetch("/api/transactions/list", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error("List request failed");
        return res.json();
      }

      async function fetchSummary() {
        const res = await fetch("/api/transactions/summary", {
          method: "POST",
        });
        if (!res.ok) return null;
        return res.json();
      }

      function updateSummaryBar(summary) {
        if (!summary) return;
        const text = `Total: ${summary.total} â€¢ Success: ${
          summary.success_count
        } â€¢ Failed: ${
          summary.failed_count
        } â€¢ Success Rate: ${summary.success_rate.toFixed(1)}%`;
        el("tx-summary").textContent = text;
      }

      function updateItemsCount() {
        const count = State.items.length;
        const text = State.next_cursor
          ? `Showing ${count} (more available)`
          : `Showing ${count}`;
        el("tx-items-count").textContent = text;
      }

      function wireRowClicks() {
        document.querySelectorAll(".tx-link").forEach((a) => {
          a.addEventListener("click", async (e) => {
            e.preventDefault();
            const sig = a.getAttribute("data-signature");
            // For now, open solscan (could add modal later)
            window.open(`https://solscan.io/tx/${sig}`, "_blank");
          });
        });
      }

      const State = {
        items: [],
        next_cursor: null,
        loading: false,
        filters: null,
      };

      async function loadInitial() {
        State.filters = buildFilters();
        AppState.save("tx.filters", State.filters);
        const data = await fetchList(State.filters, null, 50);
        State.items = data.items || [];
        State.next_cursor = data.next_cursor || null;
        const tbody = el("tx-tbody");
        tbody.innerHTML = "";
        if (State.items.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-secondary)">No transactions found</td></tr>';
        } else {
          State.items.forEach((row) => tbody.appendChild(renderRow(row)));
        }
        wireRowClicks();
        updateItemsCount();
        const summary = await fetchSummary();
        updateSummaryBar(summary);
      }

      async function loadMore() {
        if (State.loading || !State.next_cursor) return;
        State.loading = true;
        el("tx-load-more").textContent = "Loading...";
        el("tx-load-more").disabled = true;
        try {
          const data = await fetchList(State.filters, State.next_cursor, 50);
          const tbody = el("tx-tbody");
          (data.items || []).forEach((row) => {
            State.items.push(row);
            tbody.appendChild(renderRow(row));
          });
          State.next_cursor = data.next_cursor || null;
          wireRowClicks();
          updateItemsCount();
          if (!State.next_cursor) {
            el("tx-load-more").style.display = "none";
          }
        } finally {
          State.loading = false;
          el("tx-load-more").textContent = "Load more";
          el("tx-load-more").disabled = false;
        }
      }

      function applyFilters() {
        State.items = [];
        State.next_cursor = null;
        State.filters = buildFilters();
        AppState.save("tx.filters", State.filters);
        el("tx-load-more").style.display = "inline-block";
        loadInitial();
      }

      function resetFilters() {
        [
          "tx-filter-direction",
          "tx-filter-status",
          "tx-filter-router",
          "tx-filter-mint",
          "tx-filter-min-sol",
          "tx-filter-max-sol",
        ].forEach((id) => (el(id).value = ""));
        const typeSel = el("tx-filter-type");
        Array.from(typeSel.options).forEach((opt) => (opt.selected = false));
        el("tx-filter-from").value = "";
        el("tx-filter-to").value = "";
        AppState.save("tx.filters", null);
        applyFilters();
      }

      function onWsUnavailable() {
        // Fallback: ensure polling keeps the table updated
        if (!State.loading) {
          loadInitial();
        }
      }

      function onWsNew(envelope) {
        const data =
          envelope && envelope.data ? envelope.data.transaction : null;
        if (!data) return;
        const tbody = el("tx-tbody");
        const tr = renderRow(data);
        tbody.insertBefore(tr, tbody.firstChild);
        State.items.unshift(data);
        // keep around first ~500 by trimming
        if (State.items.length > 500) {
          State.items.pop();
          if (tbody.lastChild) tbody.removeChild(tbody.lastChild);
        }
        wireRowClicks();
      }

      window.PageRealtime = window.PageRealtime || {};
      window.PageRealtime.transactions = {
        channels: {
          transactions: "transactions",
          _connected: "_connected",
          _disconnected: "_disconnected",
          _failed: "_failed",
          _warning: "_warning",
        },
        onInitial() {
          applySavedFilters();
          loadInitial();
          const applyBtn = document.getElementById("tx-apply-filters");
          const resetBtn = document.getElementById("tx-reset-filters");
          const loadMoreBtn = document.getElementById("tx-load-more");

          if (applyBtn && !applyBtn.__listenerAttached) {
            applyBtn.addEventListener("click", applyFilters);
            applyBtn.__listenerAttached = true;
          }
          if (resetBtn && !resetBtn.__listenerAttached) {
            resetBtn.addEventListener("click", resetFilters);
            resetBtn.__listenerAttached = true;
          }
          if (loadMoreBtn && !loadMoreBtn.__listenerAttached) {
            loadMoreBtn.addEventListener("click", loadMore);
            loadMoreBtn.__listenerAttached = true;
          }
        },
        onEnter() {
          // Subscribe to live stream
          if (window.WsHub) {
            try {
              window.WsHub.subscribe("transactions", (env) => {
                if (!env || !env.data) return;
                if (env.data.action === "new") {
                  onWsNew(env);
                }
              });
            } catch (e) {
              console.warn("WS subscribe failed", e);
            }
          }
        },
        onExit() {
          if (window.WsHub) {
            try {
              window.WsHub.unsubscribe("transactions");
            } catch (_) {}
          }
        },
        onUnavailable() {
          onWsUnavailable();
        },
      };

      window.initTransactionsPage = function () {
        if (window.Realtime) {
          window.Realtime.activate("transactions");
        }
      };
    })();
  </script>
</div>
